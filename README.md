(((((((((((MENLAELAE:1.396745,MENLAEPAR:1.396745):0.284454,MENINY:1.681199):3.531527,MENPUM:5.212725):1.023746,(MENSIN:2.30441,MENSPE:2.30441):3.93206):0.631179,MENCHR:6.86765):0.129637,((MENREV:5.408616,MENALB:5.408616):0.710227,MENNUD:6.118842):0.878445):0.33383,MENDEN:7.331117):0.343039,(((((MENINT:3.399496,MENLONPIN:3.399496):0.803767,MENLONYAV:4.203263):2.039093,((MENLONLON:4.870013,MENPRO:4.870013):0.844683,MENLONCHI:5.714697):0.527659):0.692083,(MENMEX:3.970562,MENSAX:3.970562):2.963876):0.428678,(MENMUL2:5.635198,MENRUS:5.635198):1.727919):0.31104):0.414759,((((((MENCOL:3.355915,MENHOL:3.355915):1.141873,MENFIL:4.497787):0.718135,MENLAG:5.215922):1.300217,((MENCON:3.191386,MENLAC:3.191386):2.25254,MENSIV:5.443927):1.072212):0.464563,(((MENMAR:3.608489,MENPAR:3.608489):0.450834,MENCRO:4.059323):0.794822,MENCAN:4.854145):2.126556):0.558208,MENSPR:7.538909):0.550006):0.570814,((MENHUMGUA:2.925226,MENHUMHUM:2.925226):3.73823,(MENPER:5.245656,MENTOD:5.245656):1.417801):1.996273):1.340271,((((((((((MENLEU:2.566004,MENORE:2.566004):0.627719,MENPOL:3.193723):0.339776,MENPUB:3.533499):0.461746,MENTIE:3.995245):0.553958,MENMEM:4.549202):0.530941,(MENHUA:4.642933,MENPTE:4.642933):0.437211):0.691213,((MENARG:3.318082,MENFLU:3.318082):1.032179,MENARG2:4.350261):1.421095):0.782089,((((MENRHI:5.278252,MENUIN:5.278252):0.379562,MENMUL:5.657815):0.265513,MENGOO:5.923328):0.220475,MENLIB:6.143802):0.409643):0.71225,MENSHU:7.265695):2.460341,MENDEC:9.726036):0.273964);

Taxon,bio1,bio12,bio14,bio15,bio18,bio2,bio21,bio4,bio8,bio9,ave_petal_lgth,ave_petal_wth,petal_size,ave_mas_lgth,ave_mas_wth,mas_size,Showiness,Floral_structure,Habitat_type,Life_history,Average_NPP,showiness_res
MENALB,18.15749287,607.2840358,96.48765499,24.42688449,188.4153034,14.34155756,493.8170731,709.0632491,22.86625294,10.04497739,7.46,1.9,14.174,6.7,1.49,9.983,141.2670365,Staminode,Non_gypsum,Non_perennial,0.348816833,-0.825762872
MENARG,10.62333403,280.6848643,29.90991586,10.15808985,65.47820063,16.86299186,1642.624682,846.4815643,2.748874035,13.86010891,9.71,3.32,32.2372,6.89,1.85,12.7465,412.3001193,Stamen,Gypsum,Perennial,0.132843929,-0.697281889
MENARG2,8.903468625,256.5827903,27.16839324,16.19289466,60.13728944,17.14672706,1748.799763,884.9716989,13.82013208,0.777596269,10.39,3.65,37.9235,7.53,2.02,15.2106,575.9268083,Stamen,Gypsum,Perennial,0.199074167,-0.575065192
MENCAN,10.69817231,160.9131776,17.62365113,8.312549104,40.03584736,17.12800816,1624.872379,827.0406413,14.57742456,8.976296752,7.91,2.29,18.1139,5.65,0.97,5.4805,99.21876377,Stamen,Non_gypsum,Non_perennial,0.079734615,-1.249425046
MENCHR,10.06543394,331.6348013,56.74159848,8.347022516,140.1289267,17.07896466,1729.24637,826.840249,20.66133753,0.281799963,15.94,5.33,84.9602,14.12,3.85,54.362,4615.108336,Staminode,Non_gypsum,Non_perennial,0.245483333,0.474117309
MENCOL,9.6774623,425.0729343,61.32604434,9.834447905,128.9230149,18.54837986,2012.499918,788.9396841,18.69822268,12.85791378,13.21,4.76,62.8796,11.4,3.34,38.076,2393.284122,Staminode,Non_gypsum,Non_perennial,0.154366583,0.181813862
MENCON,7.534913009,411.0884276,66.94033647,20.45665549,143.4089836,17.95241814,2182.187025,842.520355,17.68275855,5.36693152,36.1,8.69,313.709,32.39,7.67,248.4313,77933.70577,Staminode,Non_gypsum,Non_perennial,0.2856852,1.190365188
MENCRO,13.02503351,218.5438605,29.15284588,7.679003958,58.30438657,15.73198794,1402.006989,937.8828515,21.56667934,12.42932617,11.63,3.35,38.9605,9.53,2.57,24.4921,951.7501358,Staminode,Non_gypsum,Non_perennial,0.124961604,-0.159539102
MENDEC,9.252605346,437.5396747,73.23568486,11.70623774,165.6276569,15.22372345,988.7914908,972.9800886,17.77301165,-2.009418836,57.66,18.25,1052.295,57,15.98,910.86,957997.8316,Staminode,Non_gypsum,Non_perennial,0.283173548,-0.722646061
MENDEN,8.126107978,300.1230788,55.00066236,8.04097003,129.5306798,16.89080853,2004.924667,805.7325996,17.9445049,-1.504089288,15.75,4.72,74.34,14.48,4.05,58.644,4359.742029,Staminode,Non_gypsum,Non_perennial,0.270615086,0.617578387
MENFIL,8.5830054,320.5519774,51.85026444,10.63199951,108.4158764,16.37824266,2157.429481,840.0501085,18.71239176,11.79702543,15.5,4.73,73.315,12.22,3.16,38.6152,2829.928738,Staminode,Non_gypsum,Non_perennial,0.172078256,0.150189157
MENFLU,7.925607157,277.0870211,32.05964156,15.96322747,75.31694811,16.8603862,1947.566714,817.4503817,18.01882481,-1.861507882,10.6,3.33,35.298,7.87,1.55,12.1985,428.9209997,Stamen,Gypsum,Perennial,0.22095275,-0.741399058
MENGOO,6.123833919,326.0764714,35.95953513,20.5508232,91.51793197,14.48960318,2247.397129,888.3763377,16.10446075,-1.091856335,16.26,7.55,122.763,8.57,2.76,23.6532,2893.977754,Staminode,Non_gypsum,Perennial,0.19113413,-0.505692143
MENHOL,9.683853663,363.3776802,67.73983834,10.64472249,138.0749654,18.29028565,2072.598433,761.71574,18.52599418,12.96246774,15.82,5.87,92.8634,13.66,3.77,51.4982,4781.917621,Staminode,Non_gypsum,Non_perennial,0.251889318,0.373904131
MENHUA,16.20806328,221.4011175,32.01590588,5.694342934,61.77923545,15.23998946,996.426391,882.8601128,24.40881177,19.70803086,14.81,2.98,44.1338,13.9,1.47,20.433,901.0779473,Staminode,Non_gypsum,Perennial,0.128202054,-0.345782265
MENHUMGUA,15.20741851,356.7389297,74.74024892,7.983571252,162.4944855,15.97461145,1403.242876,764.9810251,23.54476446,9.172114601,13.85,2.33,32.2705,11.76,1.36,15.9936,516.2234948,Staminode,Gypsum,Perennial,0.162187143,-0.513812299
MENHUMHUM,15.69231791,342.7341375,70.21574875,8.169723705,150.8363288,17.31517261,1205.600019,791.1680347,24.3520059,8.491124167,15.75,2.28,35.91,14.61,1.45,21.1845,760.2278354,Staminode,Gypsum,Perennial,0.142031712,-0.282192749
MENINT,15.20892467,255.9798302,35.60711752,6.949358277,59.53786671,16.37633071,1086.193518,856.420517,11.12022545,18.15973618,12.1,3.83,46.343,10.83,2.69,29.1327,1351.494575,Staminode,Non_gypsum,Non_perennial,0.140777043,-0.02144178
MENINY,9.984869038,170.2875475,23.38138208,7.965991489,35.75618894,17.64469983,1634.256144,789.6776216,4.883256574,15.80104229,13.62,2.97,40.4514,10.83,0.68,7.3644,299.3264608,Stamen,Non_gypsum,Non_perennial,0.10345925,-1.118487625
MENLAC,5.994435835,422.2587905,60.54090661,18.47291896,132.7533708,17.54100101,2324.002608,857.9684642,14.09436175,2.545224115,17.92,5.23,93.7216,16.35,4.02,65.727,6155.502092,Staminode,Non_gypsum,Non_perennial,0.313561486,0.657062497
MENLAELAE,9.570298452,404.3918147,65.88669412,9.877280901,52.4068962,14.88119559,790.9660915,741.408318,5.381759828,12.50690169,54.78,13.18,722.0004,44.46,1.62,72.0252,51833.62084,Stamen,Non_gypsum,Non_perennial,0.359052452,-1.487111375
MENLAEPAR,9.252675349,342.0852221,53.37771587,13.1268241,56.48532268,12.42658283,408.6989464,829.8501151,1.484305261,16.15587167,30.18,7.16,216.0888,23.89,0.94,22.4566,4867.560472,Stamen,Non_gypsum,Non_perennial,0.378493636,-0.85601934
MENLAG,7.406191775,307.8393967,37.33435966,16.49831293,83.88477401,16.35679596,2073.462259,865.7186428,14.1582639,3.706294763,11.23,3.99,44.8077,9.66,3.01,29.0766,1301.27883,Staminode,Non_gypsum,Non_perennial,0.187855441,-0.016923795
MENLEU,17.58005999,105.9694949,17,2,23.65939346,17.58744796,679.076342,847.4591459,9.632899211,21.31602836,10.91,3.59,39.1669,8.37,1.88,15.7356,616.9846929,Stamen,Gypsum,Perennial,0.040345,-0.551490084
MENLIB,9.214144847,278.1269773,31.28964657,16.29803978,77.44604517,14.72352371,1956.85904,962.2727014,18.42507776,-1.488618696,10.08,3.93,39.6144,6.84,3.4,23.256,919.3985809,Stamen,Non_gypsum,Perennial,0.147945484,-0.210769982
MENLONCHI,16.91079459,345.9982015,73.95932024,5.969113881,167.4279345,16.96057869,1371.551518,644.1312022,23.65677618,13.55421252,13.98,4.02,56.1996,13.19,3,39.57,2227.800671,Staminode,Non_gypsum,Non_perennial,0.209945254,0.25338896
MENLONLON,19.91793425,166.7047747,33.58981333,2.752060907,56.81899896,16.84279939,314.4042677,774.6936209,24.45514259,21.47805364,15.66,5.61,87.8526,13.48,3.86,52.0328,4569.433118,Staminode,Non_gypsum,Non_perennial,0.139143514,0.409597675
MENLONPIN,21.88819675,161.4305757,32.81367178,1.063131097,67.52263846,17.04933044,266.9213838,688.6319785,28.6727999,24.1338686,13.09,5.62,73.5658,11.61,4.92,57.1212,4204.51315,Staminode,Non_gypsum,Non_perennial,0.068160932,0.589681309
MENLONYAV,14.65169689,353.8521468,55.70927428,7.244841607,111.0052762,16.5094434,1273.811522,781.8584412,22.44531995,17.61676355,15.51,5.25,81.4275,12.77,3.49,44.5673,3623.559571,Staminode,Non_gypsum,Non_perennial,0.191101975,0.267039544
MENMAR,9.387023899,317.0030331,34.46979697,18.55845501,77.22255627,16.75781383,1702.496365,942.3958725,15.76514417,-0.553533687,11.24,3.07,34.5068,8.53,2.31,19.7043,678.2126602,Stamen,Gypsum,Non_perennial,0.258105714,-0.341974734
MENMEM,13.55293993,347.1370274,42.97418478,9.885464999,79.79846194,17.19860162,1455.849515,852.8745497,5.190778427,16.68245339,9.3,3.14,29.202,7.03,2.1,14.763,432.5671054,Stamen,Gypsum,Perennial,0.124925862,-0.569404556
MENMEX,20.02595245,295.2449336,52.8333451,6.148390393,127.663291,16.32640841,966.9145152,594.4533523,25.97999249,14.95318596,12.56,3.48,43.7088,11.99,2.78,33.3322,1455.92508,Staminode,Non_gypsum,Non_perennial,0.176100772,0.126879998
MENMUL,4.406011987,337.3872087,37.83911244,18.95092513,104.4769834,17.56333591,2299.257512,925.6023804,15.07705263,-3.573702847,14.04,7.3,102.492,8.34,2.73,22.7682,2328.768832,Stamen,Non_gypsum,Perennial,0.2447395,-0.465676099
MENMUL2,9.214395292,347.1470711,63.99875643,12.54485077,147.8962795,16.87970596,1988.192899,818.7106306,18.63506376,1.102054482,17.77,5.76,102.3552,16.01,3.58,57.3158,5863.564155,Staminode,Non_gypsum,Non_perennial,0.266400629,0.450407005
MENNUD,12.34506253,476.9340642,79.25099589,12.52907602,184.1889877,15.58733094,849.0384362,904.2135526,20.83986046,1.466400511,31.89,7.28,232.1592,30.7,6.12,187.884,43612.05389,Staminode,Non_gypsum,Non_perennial,0.278045728,1.28388244
MENORE,14.73399761,174.3406971,26.20882897,4.725331801,38.13069285,15.84722955,1171.209885,817.7267972,7.078497529,18.38638918,10.65,3.8,40.47,8.24,2,16.48,665.3199277,Stamen,Non_gypsum,Perennial,0.088720291,-0.517674082
MENPAR,10.26723558,327.0311344,38.43317372,12.91426025,83.38687344,16.59637237,1749.519442,918.8772315,17.09382616,11.62330189,11.66,3.2,37.312,8.85,2.21,19.5585,729.9716094,Staminode,Gypsum,Non_perennial,0.201179231,-0.359050406
MENPER,12.38036567,330.2281208,67.91977345,10.02509222,149.5415117,17.29070687,1808.218263,776.0451657,21.21532826,7.681906232,16.09,2.78,44.7302,14.83,2.18,32.3294,1444.345452,Staminode,Gypsum,Perennial,0.198432788,0.090750567
MENPOL,17.16031368,160.9807005,24.12775423,3.365588232,45.19902209,14.79143368,1002.705802,852.8556236,8.726682846,20.28215594,10.15,3.05,30.9575,7.72,1.77,13.6644,422.7572798,Stamen,Non_gypsum,Perennial,0.077597619,-0.638012988
MENPRO,12.84983996,313.6738321,62.61234952,8.811601881,135.6756597,17.56326096,1630.613788,783.1707441,21.72025335,9.304308368,14.43,4.7,67.821,12.74,3.16,40.2584,2733.03082,Staminode,Non_gypsum,Non_perennial,0.189234385,0.219079081
MENPTE,14.3182543,219.561261,30.03234527,7.050992137,53.62362706,16.3637456,1163.455564,915.3628809,13.35053565,13.43321329,12.03,3.89,46.7967,10.46,2.47,25.8362,1209.141669,Staminode,Non_gypsum,Non_perennial,0.138762256,-0.140164358
MENPUB,20.76919964,139.4931499,21.86317225,1.852959082,37.25303298,14.67393255,401.4678066,800.1827451,19.50261231,24.07862841,9.26,3.59,33.2434,7.48,2,14.96,497.9096212,Stamen,Non_gypsum,Perennial,0.043685439,-0.572507912
MENPUM,5.852797185,256.672402,40.41987454,10.51308386,77.98288417,15.75299996,1743.396038,962.929652,10.76732603,-5.609779181,9.02,2.61,23.5422,8.03,1.66,13.3298,314.0068594,Staminode,Non_gypsum,Non_perennial,0.175329857,-0.632826936
MENREV,18.24600219,562.3076188,88.4472953,20.09289622,189.0868455,14.34861612,406.9199953,703.0289034,24.06215744,9.879199511,16.28,5.43,88.4004,15.61,4.88,76.1768,6731.99266,Staminode,Non_gypsum,Non_perennial,0.313315168,0.872832395
MENRHI,6.98978575,386.9680216,41.79185027,22.5477368,98.65536126,16.52374248,2062.110242,900.5171105,10.93542166,-3.915158109,13.52,7.96,107.6192,8.24,3.7,30.488,3275.242855,Stamen,Non_gypsum,Perennial,0.286285595,-0.225641246
MENRUS,6.947784939,430.4708346,64.28986232,17.72406908,148.6164889,16.5238884,2242.505799,802.4605287,14.92347193,3.996318858,16.97,4.48,76.0256,14.34,2.47,35.4198,2689.445564,Stamen,Non_gypsum,Non_perennial,0.331084797,0.04911479
MENSAX,17.86377396,293.10589,61.14453488,4.967959267,140.5899175,17.11856516,1233.539694,648.7005833,24.65550345,13.22080937,11.67,3.36,39.2112,10.12,2.12,21.4544,840.4949758,Staminode,Non_gypsum,Non_perennial,0.139025633,-0.283338328
MENSHU,11.70869341,262.2770311,31.09714928,11.32871684,60.82831607,16.42898108,1495.740378,997.5064852,18.85166693,13.2554529,13.13,5.67,74.4471,9.47,4.4,41.668,3104.144266,Stamen,Non_gypsum,Perennial,0.119266628,0.226039559
MENSIN,5.905309114,388.1856726,54.75389495,14.15008764,137.490379,15.32169347,2125.491024,814.0293116,13.33344489,-3.483029429,17.83,5.38,95.9254,15.9,3.78,60.102,5774.231629,Staminode,Non_gypsum,Non_perennial,0.253494091,0.537741467
MENSIV,10.68866739,281.997013,38.2862981,10.70835744,78.08273298,16.55698685,1787.528477,907.3496607,17.63653996,14.79743907,11.31,4.59,51.9129,8.46,3.27,27.6642,1436.240895,Staminode,Non_gypsum,Non_perennial,0.148548103,-0.095195084
MENSPE,6.041833341,423.1886481,62.36185947,15.37947885,153.6846873,16.0103567,2201.226499,797.647267,14.02453688,-3.110710584,21.42,6.42,137.5164,19.62,4.46,87.5052,12030.13551,Staminode,Non_gypsum,Non_perennial,0.34763325,0.784264467
MENSPR,10.74369866,353.6187675,63.28225799,15.75962776,144.080406,16.76855361,1911.851924,848.0992553,20.63962152,1.035243748,11.72,3.79,44.4188,10.12,2.65,26.818,1191.818704,Staminode,Non_gypsum,Perennial,0.227851458,-0.09467431
MENTIE,10.37645253,232.3702193,24.77106927,13.1079082,60.2100855,18.23215496,1583.418126,854.273843,20.61986164,1.854084436,8,3,24,7,2,14,336,Stamen,Gypsum,Perennial,0.100657115,-0.594809928
MENTOD,11.10475693,316.7438372,56.8504077,15.09457743,124.7230981,17.923845,1863.144322,845.8205651,21.04231251,2.822949501,16.97,3.68,62.4496,15.68,2.9,45.472,2831.146097,Staminode,Gypsum,Perennial,0.169595625,0.378204248
MENUIN,7.920933352,300.7673732,33.41716851,16.84557591,80.11351682,16.5248509,1853.037761,985.0243866,12.86191276,-4.220950591,11.36,5.42,61.5712,7.41,4.38,32.4558,1997.395609,Stamen,Non_gypsum,Perennial,0.173107714,0.02236315


rm(list=ls())

#Date: 2024/5/20
#Time:11:35
#By: Ling

setwd("C:/JohanLing/Projects/Loasaceae/Mentzelia Section Bartonia/Environmental factors/Analysis/PCA_PGLS")###Load the libraries####
library(terra)
library(dplyr)
library(vegan)
################################STEP 5: pPCA ANALYSES#####################
################################PREPARING REQUIRED FILES##########################
#################################################################################
#Load non correlated environmental variables: file name = non_correlated bioclim layers.tif
file_path <- "non_correlated_bioclim_layers.tif"
#Load the raster date
non_correlated_stack <- rast(file_path)
#Load distribution file containing taxon, staminode,gypsum, and coordinates
dist <- read.csv(file="Distributions.20240523Cleaned.csv")

###plotting and saving species distribution on bioclimate layer
#Open the SVG device to start capturing plot output
svg("species_distribution_on_bioclimate_layer.svg")
#Basic plot of the first layer to use as a background
plot(non_correlated_stack[[1]], main="Species distribution on bioclimate layer")
#Add the point DISTRIBUTION DATA on top of the plot
points(dist$Longitude, dist$Latitude, col="black", pch=16)
#Close the SVG device to save the plot to the file
dev.off()

####Converting point data to a SpatVector and extract climate data####
points_vector <- vect(dist, geom=c("Longitude", "Latitude"), crs=crs(non_correlated_stack))
extracted_data <- terra::extract(non_correlated_stack, points_vector)

#Names of the environmental variables corresponding to the selected non-correlated layers
#If the first column in 'dist' is an unwanted ID column
extracted_data <- extracted_data[, -1]  # Removes the first column
colnames(extracted_data) <- c("bio1", #Annual_Mean_Temp
  "bio2", # Mean_Diurnal_Range
  "bio4", # Temp_Seasonality
  "bio8", # Mean_Temp_Wettest_Quarter
  "bio9", # Mean_Temp_Driest_Quarter
  "bio12", #Annual_Precip
  "bio14", # Precip_Driest_Month
  "bio15", # Precip_Seasonality
  "bio18", # Precip_Warmest_Quarter
  "bio21") # Elevation

#Add Taxon, Staminode type, gypsum type and coordinate columns to the selected non-correlated layers
extracted_data$Taxon <- dist$Taxon
extracted_data$Taxon_ID <- dist$Taxon_ID
extracted_data$Floral_structure <- dist$Floral_structure
extracted_data$Gypsum_type <- dist$Gypsum_type
extracted_data$Latitude <- dist$Latitude
extracted_data$Longitude <- dist$Longitude
extracted_data$Perennial <- dist$Perennial
extracted_data$Country <- dist$Country

#View the first few rows of the extracted data with named columns
head(extracted_data)

############CHECKING NA AND DUPLICATE######################
####Identify rows with any NA values across all columns
rows_with_na <- apply(is.na(extracted_data), 1, any)
#Display row indices that have NA values
na_row_indices <- which(rows_with_na)
#Display rows that contain NA values
na_rows <- extracted_data[na_row_indices, ]
#Print the rows with NAs
print(na_rows)
###Remove rows with NAs from the extracted_data dataframe
extracted_data_na_rem <- na.omit(extracted_data)
#View the cleaned extracted data
head(extracted_data_na_rem)

####Identify and remove duplicate coordinates within each taxon
extracted_data_dup <- extracted_data_na_rem %>%
  group_by(Taxon, Longitude, Latitude, Country, Gypsum_type, Perennial, Floral_structure) %>%
  distinct() %>%
  ungroup()
head(extracted_data_dup)
#verify no duplicates after removal
verify <- extracted_data_dup %>%
  group_by(Taxon, Longitude, Latitude, Country, Gypsum_type, Perennial, Floral_structure) %>%
  filter(n() > 1) %>%
  ungroup()
#Check if there are any duplicates left
if(nrow(verify) > 0) {
  print("Duplicates still exist within taxa after removal.")
} else {
  print("No duplicates exist within taxa after removal.")
}


##############there are two rows of elevation with -36 and -1#################
############################## detete them #################################
#there are negative values in Bi021, check this.use 4 m instead of -1
#Save the duplicate data as a CSV file
#write.csv(extracted_data_dup, file = "extracted_data_dup_withMinus.csv", row.names = FALSE)
###Load the CSV file
extracted_data_dup <- read.csv("extracted_data_dup_withMinus.csv")

################FILTER MENLONLON##############
mlon <- extracted_data_dup %>% filter(Taxon == "MENLONLON")
#GENERATE DENSITY PLOT FOR BIO21
library(ggplot2)
ggplot(mlon, aes(x = bio21)) +
  geom_density(fill = "blue", alpha = 0.5) +
  labs(title = "Density Plot of bio21 for MENLONLON", x = "bio21", y = "Density") +
  theme_minimal()

mlon1 <- mlon %>% filter(bio21 != -36)
ggplot(mlon1, aes(x = bio21)) +
  geom_density(fill = "blue", alpha = 0.5) +
  labs(title = "Density Plot of bio21 for MENLONLON", x = "bio21", y = "Density") +
  theme_minimal()
###############calculate sample size for each country#############
##################################################################
###OUNTING UNIQUE TAXA AND INDIVIDUALS PER COUNTRY###

#Count the number of individuals for each country after removing duplicates and NAs
individuals_by_country <- extracted_data_dup %>%
  group_by(Country) %>%
  summarise(Num_Individuals = n())

#Count the number of unique taxa for each country after removing duplicates and NAs
taxa_by_country <- extracted_data_dup %>%
  group_by(Country) %>%
  summarise(Unique_Taxa = n_distinct(Taxon))

#Merge the two dataframes to get a complete summary
summary_by_country <- merge(individuals_by_country, taxa_by_country, by = "Country")

#Print the summary
print(summary_by_country)



#Count the total number of individuals after removing duplicates and NAs
total_individuals <- nrow(extracted_data_dup)

#Count the total number of unique taxa across all countries after removing duplicates and NAs
total_taxa <- n_distinct(extracted_data_dup$Taxon)

#Print the total counts
cat("Total number of individuals:", total_individuals, "\n")
cat("Total number of unique taxa:", total_taxa, "\n")

#Count the number of individuals for each species (Taxon)
sample_size_by_species <- extracted_data_dup %>%
  group_by(Taxon) %>%
  summarise(Sample_Size = n()) %>%
  arrange(desc(Sample_Size))  # Arrange by sample size in descending order

#Print the sample size difference across species

#Calculate the sample size for each species (Taxon)
sample_size_by_species <- extracted_data_dup %>%
  group_by(Taxon) %>%
  summarise(Sample_Size = n()) %>%
  arrange(desc(Sample_Size))  #Arrange by sample size in descending order

#Calculate the mean sample size across species
mean_sample_size <- mean(sample_size_by_species$Sample_Size)

#Print the mean sample size
cat("Mean sample size across species:", mean_sample_size, "\n")


#Count the number of individuals and unique taxa for Staminode presence
staminode_presence <- extracted_data_dup %>%
  filter(Floral_structure == "Staminode") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

#Count the number of individuals and unique taxa for Staminode absence
staminode_absence <- extracted_data_dup %>%
  filter(Floral_structure == "Stamen") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

#Print the results
cat("Staminode Presence - Total Individuals:", staminode_presence$Total_Individuals, 
    " | Unique Taxa:", staminode_presence$Unique_Taxa, "\n")

cat("Staminode Absence - Total Individuals:", staminode_absence$Total_Individuals, 
    " | Unique Taxa:", staminode_absence$Unique_Taxa, "\n")


# Count the number of individuals and unique taxa for Gypsum affinity (gypsum-adapted taxa)
gypsum_adapted <- extracted_data_dup %>%
  filter(Gypsum_type == "gypsum") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

# Count the number of individuals and unique taxa for non-Gypsum taxa
non_gypsum_adapted <- extracted_data_dup %>%
  filter(Gypsum_type == "nongypsum") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

# Print the results
cat("Gypsum-Adapted - Total Individuals:", gypsum_adapted$Total_Individuals, 
    " | Unique Taxa:", gypsum_adapted$Unique_Taxa, "\n")

cat("Non-Gypsum-Adapted - Total Individuals:", non_gypsum_adapted$Total_Individuals, 
    " | Unique Taxa:", non_gypsum_adapted$Unique_Taxa, "\n")

# Count the number of individuals and unique taxa for Perennials
perennials <- extracted_data_dup %>%
  filter(Perennial == "Yes") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

# Count the number of individuals and unique taxa for Non-Perennials
non_perennials <- extracted_data_dup %>%
  filter(Perennial == "No") %>%
  summarise(Total_Individuals = n(), Unique_Taxa = n_distinct(Taxon))

# Print the results
cat("Perennials - Total Individuals:", perennials$Total_Individuals, 
    " | Unique Taxa:", perennials$Unique_Taxa, "\n")

cat("Non-Perennials - Total Individuals:", non_perennials$Total_Individuals, 
    " | Unique Taxa:", non_perennials$Unique_Taxa, "\n")

#################################################################################
###CALCULATING LOG GEOMETRIC MEANS FOR EACH ENVIRONMENTAL VARIABLE WITHIN EACH TAXON#####
#################################################################################
library(tidyverse) #For pivot_longer, ggplot2, and dplyr
#Pivot extracted_data_dup
data_long <- pivot_longer(
  extracted_data_dup,
  cols = c("bio1", #Annual_Mean_Temp
            "bio2", # Mean_Diurnal_Range
            "bio4", # Temp_Seasonality
            "bio8", # Mean_Temp_Wettest_Quarter
            "bio9", # Mean_Temp_Driest_Quarter
            "bio12", # Annual_Precip
            "bio14", # Precip_Driest_Month
            "bio15", # Precip_Seasonality
            "bio18", # Precip_Warmest_Quarter
            "bio21"),#Elevation
  names_to = "Env_variable",
  values_to = "Value"
)

#Define the offset
offset <- 37  #We got -36.00, so I will use 37 to get the positive values here
#Adjust values by adding the new offset
data_long <- data_long %>%
  mutate(Adjusted_Value = Value + offset)
#Calculate the geometric means with log transformation and drop offset to make it original data
geometric_mean_values <- data_long %>%
  group_by(Taxon, Env_variable) %>%
  summarise(
    Geometric_Mean = exp(mean(log(Adjusted_Value), na.rm = TRUE)) - offset,
    .groups = 'drop'
  )

###OR######
#no offset
#Define the offset to convert all negative values to positive
#min_value <- min(data_long$Value, na.rm = TRUE)
#offset <- abs(min_value) + 1  # Offset is abs(-36) + 1 = 37

#Convert values to positive by adding the offset
#data_long <- data_long %>%
#  mutate(Adjusted_Value = Value + offset)

#Apply log transformation to the adjusted positive values
#data_long <- data_long %>%
 # mutate(Log_Adjusted_Value = log(Adjusted_Value))

#Calculate the geometric mean using the log-transformed values
#geometric_mean_values <- data_long %>%
#  group_by(Taxon, Env_variable) %>%
 # summarise(
 #   Geometric_Mean = exp(mean(Log_Adjusted_Value, na.rm = TRUE)),  #No offset subtraction
 #   .groups = 'drop'
 # )

#Display the geometric mean values
#print(geometric_mean_values)


#Calculate the geometric mean without explicit log transformation
#geometric_mean_values_nolog <- data_long %>%
#  group_by(Taxon, Env_variable) %>%
#  summarise(
#    Geometric_Mean = (prod(Adjusted_Value, na.rm = TRUE))^(1/n()),  # Using the product and nth root directly
#    .groups = 'drop'
  #)

#Subtract the offset after geometric mean calculation
#geometric_mean_values_nolog <- geometric_mean_values_nolog %>%
#  mutate(Geometric_Mean = Geometric_Mean - offset)
#Display the geometric mean values
#print(geometric_mean_values_nolog)



#Pivot the data wider using geometric_mean_values
geometric_mean_values_wide <- geometric_mean_values %>%
pivot_wider(names_from = Env_variable, values_from = Geometric_Mean)

#Create a summary table of taxa with their respective Staminode_type and Gypsum_type
library(dplyr)
#Convert to tibble and create a summary table
geo_taxon_types <- extracted_data_dup %>%
  as_tibble() %>%
  dplyr::select(Taxon, Floral_structure, Gypsum_type, Perennial) %>%
  distinct()

geo_taxon_types <- dplyr::select(extracted_data_dup, Taxon, Floral_structure, Gypsum_type, Perennial) %>%
  distinct()
#Join this summary table with the geometric_mean_values_wide to add the Staminode_type and Gypsum_type information back
geo_cbind_taxon_env <- geometric_mean_values_wide %>%
  left_join(geo_taxon_types, by = "Taxon")

write.csv(geo_cbind_taxon_env, file = "geo_cbind_taxon_env.csv", row.names = FALSE)
write.csv(geo_cbind_taxon_env, file = "geo_cbind_taxon_env_withoffset.csv", row.names = FALSE)


####################Phylogenetic PCA####################################
####FIRST: PERFORMING PCA ON GEOMETRIC MEAN DATASET#####################

#Load Necessary Libraries
library(dplyr)
library(ggplot2)
library(caper)
library(phytools)
library(ape)
library(geiger)
library(phylolm)

#Load the Data and Phylogenetic Tree
data <- read.csv("geo_cbind_taxon_env_plus_trait.csv", stringsAsFactors = FALSE)

head(data)


##########################################################
######################NPP#################################
################## Extract Average_NPP Data ##############
##########################################################
#Extract the necessary columns for analysis (Average_NPP and Staminode type)
npp_data <- data %>%
  dplyr::select(Taxon, Floral_structure, Showiness, mas_size, petal_size, Habitat_type, Life_history, Average_NPP) %>%
  filter(!is.na(Average_NPP))

#Convert to data frame and set row names
npp_data <- as.data.frame(npp_data)
rownames(npp_data) <- npp_data$Taxon


#################################################################
################### Check Normality for NPP######################
#################################################################
#Q-Q Plot for Visual Inspection
qq_plot <- ggplot(npp_data, aes(sample = Average_NPP)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Q-Q Plot for Average_NPP", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

print(qq_plot)

#Shapiro-Wilk Test for Normality
shapiro_test <- shapiro.test(npp_data$Average_NPP)
print(shapiro_test)

#################################################################
################### Check Normality for petal size###############
#################################################################
#Q-Q Plot for Visual Inspection
qq_plot_petal <- ggplot(npp_data, aes(sample = petal_size)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Q-Q Plot for Petal Size", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

print(qq_plot_petal)

#Shapiro-Wilk Test for Normality
shapiro_test <- shapiro.test(npp_data$petal_size)
print(shapiro_test)

#################################################################
################### Check Normality for mas size###############
#################################################################
#Q-Q Plot for Visual Inspection
qq_plot_mas <- ggplot(npp_data, aes(sample = mas_size)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Q-Q Plot for MAS Size", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

print(qq_plot_mas)

#Shapiro-Wilk Test for Normality
shapiro_test <- shapiro.test(npp_data$mas_size)
print(shapiro_test)

#PETAL, MAS are not normally distributed so do log transformation for checking the model fit
npp_data$log_petal_size <- log(npp_data$petal_size)
npp_data$log_mas_size <- log(npp_data$mas_size)
#Shapiro-Wilk Test for Normality
log_petal_size <- shapiro.test(npp_data$log_petal_size)
print(log_petal_size)
log_mas_size <- shapiro.test(npp_data$log_mas_size)
print(log_mas_size)
#still not improving
################################################################
####################RUN LM PETAL AND MAS MODEL FIT############
################################################################
###Staminode and stamen combined##########
#Define the GLM model with mas_size as the response variable and petal_size as the predictor
glm_model <- glm(mas_size ~ petal_size, data = npp_data,
                family = Gamma(link = "log"))
#Print the summary of the gm model
glm_summary <- summary(glm_model)
print(glm_summary)

####Staminode alone########
glm_staminode <- glm(mas_size ~ petal_size, 
                     data = subset(npp_data, Floral_structure == "Staminode"), 
                     family = Gamma(link = "log"))
summary_staminode <- summary(glm_staminode)
print(summary_staminode)


####Stamen alone########
glm_stamen <- glm(mas_size ~ petal_size, 
                  data = subset(npp_data, Floral_structure == "Stamen"), 
                  family = Gamma(link = "log"))
summary_stamen <- summary(glm_stamen)
print(summary_stamen)




###Find the residuals for both of staminodes and stamens
#Diagnostic plots to check residuals
par(mfrow = c(2, 2))
plot(glm_model)
#Extract residuals
residuals_glm <- residuals(glm_model)
#Create a data frame with Taxon and corresponding residuals
residuals_df <- data.frame(Taxon = rownames(npp_data), showiness_res = residuals_glm)
#Merge the residuals data frame with the original npp_data on the Taxon column
npp_data <- merge(npp_data, residuals_df, by = "Taxon")
#View the first few rows to confirm the new column is added
head(npp_data)
#Calculate correlation between log-transformed petal size and MAS size using Pearson method
correlation <- cor(npp_data$petal_size, npp_data$mas_size, method = "pearson")
#Extract the p-value for the slope coefficient (petal_size) from the linear model summary
p_value <- glm_summary$coefficients[2, 4]  #[2, 4] corresponds to the slope's p-value in the coefficients matrix
#Print correlation and p-value
print(paste("Correlation between petal size and MAS size:", correlation))
print(paste("P-value for the slope coefficient:", p_value))


#Create the density plot for residuals with a vertical line at zero
#################################################################
################### Check Normality for residuals################
#################################################################
#Q-Q Plot for Visual Inspection
qq_plot_res <- ggplot(npp_data, aes(sample = showiness_res)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Q-Q Plot for Showiness", x = "Theoretical Quantiles", y = "Sample Quantiles") +
  theme_minimal()

print(qq_plot_res)

#Shapiro-Wilk Test for Normality
shapiro_test <- shapiro.test(npp_data$showiness_res)
print(shapiro_test)

npp_data$log_showiness_res <- log(npp_data$showiness_res+3)
shapiro_test <- shapiro.test(npp_data$log_showiness_res)
print(shapiro_test)

#Load necessary library
library(ggplot2)
residual_density_plot <- ggplot(npp_data, aes(x = showiness_res)) +
  geom_density(fill = "black", alpha = 0.5) +
  geom_vline(xintercept = 0, color = "black", linetype = "solid") +
  labs(x = "Residuals", y = "Density") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 22, color = "black")
  )
#Print the plot
print(residual_density_plot)
#Save the plot as SVG
ggsave("residual_density_plot.svg", plot = residual_density_plot, device = "svg", bg = "white")
#write.csv(npp_data, file = "geo_cbind_taxon_env_with_MASresidual.csv", row.names = FALSE)



#Create the density plot with curve lines
residual_density_plot <- ggplot(npp_data, aes(x = showiness_res, color = Floral_structure, linetype = Floral_structure)) +
  geom_density(size = 1.5) +
  geom_vline(xintercept = 0, color = "black", linetype = "solid") +
  scale_color_manual(values = c("Stamen" = "orange", "Staminode" = "#377EB8")) +  
  scale_linetype_manual(values = c("Stamen" = "solid", "Staminode" = "dashed")) +  
  labs(x = "Residuals", y = "Density", color = "Floral organ", linetype = "Floral organ") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  #Remove major grid lines
    panel.grid.minor = element_blank(),  #Remove minor grid lines
    axis.line.x = element_line(color = "black", size = 0.5),  #Add x-axis line
    axis.line.y = element_line(color = "black", size = 0.5),  #Add y-axis line
    axis.ticks = element_line(color = "black", size = 1),  #Add axis ticks in black
    axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
    panel.border = element_rect(color = "black", fill = NA, size = 2),  #Add border around the plot
    axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
    legend.title = element_text(family = "Times New Roman", size = 24, color = "black"),#Axis title style
    axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),  #Axis text style
    legend.text = element_text(family = "Times New Roman", size = 22, color = "black"),
    legend.position = "none"  #Hide the legend
  )
#Print the plot
print(residual_density_plot)
#Save the plot as an SVG file
ggsave(filename = "Residuals with staminode and stamen.svg", plot = residual_density_plot, device = "svg", width = 9, height = 7, units = "in")


################################################################
################Phylogenetic Tree Preparation###################
################################################################
###Load necessary libraries
library(phytools)
library(ape)
library(geiger)
tree <- read.tree("BartoniaIngroupPLnames.tre")
plot(tree)

#Ensure that taxa in npp_data match those in the tree
npp_data <- npp_data[npp_data$Taxon %in% tree$tip.label, ]


######Staminode vs NPP#########
###############################
#npp_data_filtered1 <- npp_data_filtered %>% mutate(Presence = ifelse(Staminode_type == "Presence", 1,0))
#Convert Staminode_type to numeric if not already done in your dataset
#npp_data <-npp_data$Staminode_type <- as.numeric(as.factor(npp_data$Staminode_type))

library(caper)
comp_data <- comparative.data(tree, npp_data, names.col = "Taxon")


#MAS Showiness#both staminode and stamens
pgls_showiness <- pgls(showiness_res ~ Average_NPP + Floral_structure, data = comp_data)
summary(pgls_showiness)



#Staminode#Run pANOVA
library(nlme)
#Perform Phylogenetic ANOVA
#Grouping variable: Floral_organ
pANOVA_result <- phylANOVA(tree, x = npp_data$Floral_structure, y = npp_data$Average_NPP)
#Check the tree tip labels
print(tree$tip.label)

#Check the dataset Taxon column
print(npp_data$Taxon)

#Identify mismatches
mismatched_taxa <- setdiff(tree$tip.label, npp_data$Taxon)
cat("Taxa in tree but not in data:", mismatched_taxa, "\n")

mismatched_taxa_data <- setdiff(npp_data$Taxon, tree$tip.label)
cat("Taxa in data but not in tree:", mismatched_taxa_data, "\n")
#Subset npp_data to include only taxa in the tree
npp_data <- npp_data[npp_data$Taxon %in% tree$tip.label, ]

#Verify that all taxa now match
all(npp_data$Taxon %in% tree$tip.label) # Should return TRUE

#Perform phylogenetic ANOVA
pANOVA_result <- phylANOVA(tree, x = npp_data$Floral_structure, y = npp_data$Average_NPP)

#Display the results
print(pANOVA_result)

#####To avoid warning####
#########################
#Explicitly add labels to y and x
y_named <- setNames(npp_data$Average_NPP, npp_data$Taxon)
x_named <- setNames(npp_data$Floral_structure, npp_data$Taxon)

#Perform phylogenetic ANOVA with labeled variables
pANOVA_result <- phylANOVA(tree, x = x_named, y = y_named)

#Display the results
print(pANOVA_result)


######run PGLS only for taxa with staminode###########
#Extract taxa with staminodes
taxa_with_staminodes <- data$Taxon[data$Floral_structure == "Staminode"]
#Prune the tree to include only taxa with staminodes
pruned_tree <- drop.tip(tree, setdiff(tree$tip.label, taxa_with_staminodes))
#Subset the data to include only taxa with staminodes
pruned_data <- data[data$Taxon %in% taxa_with_staminodes, ]

#Log-transform Average_NPP and add it as a new column
#pruned_data$log_Average_NPP <- log(pruned_data$Average_NPP)

#Ensure row names match tip labels for compatibility with PGLS
rownames(pruned_data) <- pruned_data$Taxon
#Prepare the comparative data object
comp_data <- comparative.data(pruned_tree, pruned_data, names.col = "Taxon")
#Run PGLS
pgls_model <- pgls(showiness_res ~ Average_NPP, data = comp_data)
#Display the summary of the PGLS model
summary(pgls_model)

#Plot diagnostic plots for residuals
par(mfrow = c(2, 2))
plot(pgls_model)




######run PGLS only for taxa without staminode###########
#Extract taxa with staminodes
taxa_without_staminodes <- data$Taxon[data$Floral_structure == "Stamen"]
#Prune the tree to include only taxa without staminodes
pruned_tree1 <- drop.tip(tree, setdiff(tree$tip.label, taxa_without_staminodes))
#Subset the data to include only taxa without staminodes
pruned_data1 <- data[data$Taxon %in% taxa_without_staminodes, ]
#Ensure row names match tip labels for compatibility with PGLS
rownames(pruned_data1) <- pruned_data1$Taxon
#Prepare the comparative data object
comp_data1 <- comparative.data(pruned_tree1, pruned_data1, names.col = "Taxon")
#Run PGLS
pgls_model1 <- pgls(showiness_res ~ Average_NPP, data = comp_data1)
#Display the summary of the PGLS model
summary(pgls_model1)

#Plot diagnostic plots for residuals
par(mfrow = c(2, 2))
plot(pgls_model1)


###########Run PGLMM for Petal size (mm)############
#calculate overdispersion 
#Fit the Poisson model first
poisson_model <- glm(log_petal_size ~ Average_NPP + Floral_structure, 
                     data = npp_data, 
                     family = poisson())

#Calculate the overdispersion statistic
overdispersion_stat <- sum(residuals(poisson_model, type = "pearson")^2) / poisson_model$df.residual
#Print the overdispersion statistic
print(overdispersion_stat)#greater than 1 means overdispersion

library(phyr)
#Run PGLMM model including observation-level random effect
pglmm_model_petal <- pglmm(
  log_petal_size ~ Average_NPP + Floral_structure + (1 | log_mas_size), #Added observation-level random effect
  data = npp_data,
  family = "gaussian",  #Use Gaussian if data is continuous and normally distributed
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
summary(pglmm_model_petal)



#########################################################
##############mean and standard error NPP################
#########################################################
#Load necessary library
library(dplyr)
#Calculate the mean value of Average_NPP for staminode presence and absence
mean_npp_staminode <- npp_data %>%
  group_by(Floral_structure) %>%
  summarise(
    Mean_Average_NPP = mean(Average_NPP, na.rm = TRUE),
    SE_Average_NPP = sd(Average_NPP, na.rm = TRUE) / sqrt(n()) #Standard Error
  )
#Print the results
print(mean_npp_staminode)

#########################################################
##########mean and standard error MAS showiness##########
#########################################################
#Load necessary library
library(dplyr)
#Calculate the mean and standard error of flower showiness for staminode presence and absence
mean_masshowiness_staminode <- npp_data %>%
  group_by(Floral_structure) %>%
  summarise(
    Mean_masShowiness = mean(showiness_res, na.rm = TRUE),
    SE_masShowiness = sd(showiness_res, na.rm = TRUE) / sqrt(n())  # Standard Error
  )

# Print the results
print(mean_masshowiness_staminode)

#########################################################
########mean and standard error Petal size###############
#########################################################
#Load necessary library
library(dplyr)
#Calculate the mean and standard error of flower showiness for staminode presence and absence
mean_petalshowiness_staminode <- npp_data %>%
  group_by(Floral_structure) %>%
  summarise(
    Mean_petalShowiness = mean(petal_size, na.rm = TRUE),
    SE_petalShowiness = sd(petal_size, na.rm = TRUE) / sqrt(n())  # Standard Error
  )

#Print the results
print(mean_petalshowiness_staminode)



###################################################################
##############GGPLOT2: NPP FOR MAS SHOWINESS#######################
###################################################################
#Load necessary library
library(ggplot2)
library(grid)

theme <-  theme(
  panel.grid.major = element_blank(),  #Remove major grid lines
  panel.grid.minor = element_blank(),  #Remove minor grid lines
  axis.line.x = element_line(color = "black", size = 0.5),  #Add x-axis line
  axis.line.y = element_line(color = "black", size = 0.5),  #Add y-axis line
  axis.ticks = element_line(color = "black", size = 1),  #Add axis ticks in black
  axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
  panel.border = element_rect(color = "black", fill = NA, size = 2),  #Add border around the plot
  axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),  #Axis title style
  legend.title = element_text(family = "Times New Roman", size = 24, color = "black"),#Axis title style
  axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),  #Axis text style
  legend.text = element_text(family = "Times New Roman", size = 22, color = "black"),
  legend.position = "none"  # Hide the legend
)

##########################mas showiness#########################################
#############################ggplot2############################################
#Create the boxplot with jittered points
npp_plot <- ggplot(npp_data, aes(x = Floral_structure, y = Average_NPP, fill = Floral_structure)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA, color = "black") +  # Boxplot with no outlier points
  geom_jitter(aes(shape = Floral_structure, color = Floral_structure), size = 8, width = 0.2) +  #Jittered points with specific shape
  scale_fill_manual(name = "Floral organ",  # Rename the legend title for fill
    values = c("Stamen" = "darkorange", "Staminode" = "#377EB8")) +
  scale_color_manual(name = "Floral organ",  # Rename the legend title for color
    values = c("Stamen" = "darkorange", "Staminode" = "#377EB8")) +
  scale_shape_manual(name = "Floral organ",  # Rename the legend title for shape
    values = c("Stamen" = 21, "Staminode" = 17)) +
  labs(x = "Taxa", y = expression("Mean net primary productivity (g C m"^-2~yr^-1*")")) +  #Labels for x and y axes
  theme_minimal() +  # Minimal theme to start with
  theme + scale_x_discrete(labels = c("Without staminode", "With staminode")) +
  annotate("text",x = 0.5,y = max(npp_data$Average_NPP) + 0.05,label = "(a)",hjust = 0,vjust = 1, size = 8, family = "Times New Roman")

#Print the plot
print(npp_plot)
#Save the plot as an SVG file
ggsave(filename = "npp_plot.svg", plot = npp_plot, device = "svg", width = 9, height = 7, units = "in")

############
#Load necessary library
library(ggplot2)
theme1 <-  theme(
  panel.grid.major = element_blank(),  #Remove major grid lines
  panel.grid.minor = element_blank(),  #Remove minor grid lines
  axis.line.x = element_line(color = "black", size = 0.5),  #Add x-axis line
  axis.line.y = element_line(color = "black", size = 0.5),  #Add y-axis line
  axis.ticks = element_line(color = "black", size = 1),  #Add axis ticks in black
  axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
  panel.border = element_rect(color = "black", fill = NA, size = 2),  #Add border around the plot
  axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
  legend.title = element_text(family = "Times New Roman", size = 24, color = "black"),#Axis title style
  axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),  #Axis text style
  legend.text = element_text(family = "Times New Roman", size = 22, color = "black"),
  legend.position = "none"  #Hide the legend
)
#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Staminode" = 17, "Stamen" = 16)  #16 for circle, 17 for triangle
#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
npp_showiness_plot <- ggplot(npp_data, aes(x = Average_NPP, y = showiness_res, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  # Set custom shapes
  labs(x = expression("Mean net primary productivity (g C m"^-2~yr^-1*")"), y = "Showiness (residuals)") +  #Label the axes
  ylim(-1.6, 1.6) +  # Set the y-axis limits
  theme_minimal() +  #Apply a minimal theme
  theme1 + 
  annotate("text", x = min(npp_data$Average_NPP), y = max(npp_data$showiness_res) + 0.28,
           label = "(a)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
print(npp_showiness_plot)
ggsave(filename = "this is for LEgend.svg", plot = npp_showiness_plot, device = "svg", width = 9, height = 7, units = "in")


##################################Petal showiness##############################
###############################################################################

#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  #16 for circle, 17 for triangle
#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
npp_petal <- ggplot(npp_data, aes(x = Average_NPP, y = log_petal_size, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  # Set custom shapes
  labs(x = expression("Mean net primary productivity (g C m"^-2~yr^-1*")"), y = "Log petal showiness (mmÂ²)") +  #Label the axes
  theme_minimal() +  #Minimal theme to start with
  theme1 +
  annotate("text", x = min(npp_data$Average_NPP), y = max(npp_data$showiness_res) + 6, label = "(a)", 
           hjust = 0, vjust = 1, size = 8, family = "Times New Roman")  
print(npp_petal)
#ggsave(filename = "this is for LEgend for petal.svg", plot = npp_petal, device = "svg", width = 9, height = 7, units = "in")

##############################################################
########PHYLOGENETIC PCA FOR ENVIRONMENTAL VARIABLES##########
##############################################################
#Select only the environmental variables (columns starting with "bio")
env_data <- dplyr::select(data, starts_with("bio"))
#Standardize the environmental variables (mean = 0, variance = 1)
env_data_scaled1 <- scale(env_data)
#Create a new data frame with scaled data and Taxon as the first column
env_data_scaled1 <- as.data.frame(env_data_scaled1) %>%
  mutate(Taxon = data$Taxon)  # Adding the Taxon column
#Set the row names to be Taxon for matching
rownames(env_data_scaled1) <- env_data_scaled1$Taxon
#Check and match species between the data and the phylogenetic tree
#Get species names from tree and scaled data
tree_species <- tree$tip.label
data_species <- rownames(env_data_scaled1)
pca_result <- phyl.pca(tree, env_data_scaled1[, -ncol(env_data_scaled1)], method = "BM", mode = "corr")
#Get summary of PCA result
pca_summary <- summary(pca_result)
#Print the proportion of variance explained by each PC
print(pca_summary$importance)

###Extract the proportion of variance for the first three PCs
proportion_variance <- pca_summary$importance[2, 1:3] * 100

###Print the percentage of variance explained by PC1, PC2, and PC3
cat("Percentage of Variance Explained by PC1:", round(proportion_variance[1], 2), "%\n")
cat("Percentage of Variance Explained by PC2:", round(proportion_variance[2], 2), "%\n")
cat("Percentage of Variance Explained by PC3:", round(proportion_variance[3], 2), "%\n")

###Get the PCA scores and loadings
pca_scores <- as.data.frame(pca_result$S)
pca_loadings <- pca_result$L

###Add taxon names to the PCA scores
pca_scores$taxon <- rownames(pca_scores)

###Print the PCA scores
print(pca_scores)

###Print the PCA loadings
print(pca_loadings)

###Create a data frame for the variable loadings (first three PCs)
loadings_df <- as.data.frame(pca_loadings[, 1:3])
loadings_df$variable <- rownames(loadings_df)
print(loadings_df)
#("bio1", #Annual_Mean_Temp
          # "bio2", # Mean_Diurnal_Range
          # "bio4", # Temp_Seasonality
         #  "bio8", # Mean_Temp_Wettest_Quarter
         #  "bio9", # Mean_Temp_Driest_Quarter
        #   "bio12", # Annual_Precip
        #   "bio14", # Precip_Driest_Month
        #   "bio15", # Precip_Seasonality
        #   "bio18", # Precip_Warmest_Quarter
        #   "bio21"),#Elevation

###Create a data frame for the scores
scores_df <- as.data.frame(pca_scores)

###Merge taxon, staminode type, and other relevant info
scores_df <- cbind(scores_df, data[, c("Taxon", "Floral_structure", "Habitat_type", "mas_size", "petal_size", "Average_NPP", "Life_history", "Average_NPP")])

###PERMANOVA for BIOCLIMATIC VARIABLES AND STAMINODE TYPE#####
library(RVAideMemoire)
pca_df_filtered <- scores_df[,1:3]
pca_perm <-adonis2(pca_df_filtered ~ Floral_structure,
                   data=scores_df, permutations = 9999, method = "euclidean")
pca_perm
#pairwise.perm.manova(dist(pca_df_filtered,"euclidean"),scores_df$Perennial,nperm=9999, p.method = "none")




#######################################################
####PGLM FOR FLOWER SHOWINESS ON PC1 PC2 AND PC3######
#####################################################
#Combine the data frames of scores df and showiness_res
#check row names of scores_df
head(rownames(scores_df))
#Add taxon column using row names
scores_df$Taxon <- rownames(scores_df)
#check taxon and showiness_res are in npp_data
head(npp_data[, c("Taxon", "showiness_res", "log_petal_size", "log_mas_size")])
#merge scores_df with npp_data to include showiness_res
cbind_data <-merge(scores_df, npp_data[, c("Taxon", "showiness_res","log_mas_size", "log_petal_size")], by = "Taxon")
head(cbind_data)

#MAS showiness: combine staminode presence and absence
##Run PGLS
comp_data_cbind <- comparative.data(tree, cbind_data, names.col = "Taxon")
#Staminodes
pgls_showiness_cbind <- pgls(showiness_res ~ Floral_structure, data = comp_data_cbind)
summary(pgls_showiness_cbind)


######run PGLS only for taxa with staminode###########
#Extract taxa with staminodes
taxa_with_staminodes2 <- cbind_data$Taxon[cbind_data$Floral_structure == "Staminode"]
pruned_tree2 <- drop.tip(tree, setdiff(tree$tip.label, taxa_with_staminodes2))
pruned_data2 <- cbind_data[cbind_data$Taxon %in% taxa_with_staminodes2, ]
rownames(pruned_data2) <- pruned_data2$Taxon
comp_data2 <- comparative.data(pruned_tree2, pruned_data2, names.col = "Taxon")
pgls_model2 <- pgls(showiness_res ~ PC1 + PC2 + PC3, data = comp_data2)
summary(pgls_model2)
par(mfrow = c(2, 2))
plot(pgls_model2)


######run PGLS only for taxa without staminode###########
#Extract taxa without staminodes
taxa_without_staminodes2 <- cbind_data$Taxon[cbind_data$Floral_structure == "Stamen"]
pruned_tree3 <- drop.tip(tree, setdiff(tree$tip.label, taxa_without_staminodes2))
pruned_data3 <- cbind_data[cbind_data$Taxon %in% taxa_without_staminodes2, ]
rownames(pruned_data3) <- pruned_data3$Taxon
comp_data3 <- comparative.data(pruned_tree3, pruned_data3, names.col = "Taxon")
pgls_model3 <- pgls(showiness_res ~ PC1 + PC2 + PC3, data = comp_data3)
summary(pgls_model3)
par(mfrow = c(2, 2))
plot(pgls_model3)








#Petal showiness
#Run PGLMM model including observation-level random effect
pglmm_model_petal <- pglmm(
  log_petal_size ~ PC1 + PC2 + PC3 + Floral_structure + (1 | log_mas_size), #Added observation-level random effect
  data = cbind_data,
  family = "gaussian",  #Use Gaussian if data is continuous and normally distributed
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
summary(pglmm_model_petal)


#########################################FIGURE##################################
############ggplots: BIOCLIMATIC VARIABLES:PLOTTING STAMINODE TYPE###############
################################################
###Define the environmental variable names
#bio_variable_names <- c(
#  "bio1" = "Annual Mean Temperature",
# "bio2" = "Mean Diurnal Range",
#  "bio4" = "Temperature Seasonality",
#  "bio8" = "Mean Temperature of Wettest Quarter",
#  "bio9" = "Mean Temperature of Driest Quarter",
#  "bio12" = "Annual Precipitation",
#  "bio14" = "Precipitation of Driest Month",
##  "bio15" = "Precipitation Seasonality",
#  "bio18" = "Precipitation of Warmest Quarter",
# "bio21" = "Elevation")
###Apply the named vector to the row names of the loadings data frame
#loadings_df$variable <- bio_variable_names[rownames(loadings_df)]

#Scaling factor for the loadings, adjust this as needed
scaling_factor <- 7  #Adjust this scaling factor as appropriate for the plot
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC2))) / max(abs(c(loadings_df$PC1, loadings_df$PC2))) * 0.8


#Create a PCA1 and PC2 biplot with ggplot2
staminode_shapes <- c("Staminode" = 17, "Stamen" = 16)  # 16 for circle, 17 for triangle
library(ggplot2)
labs(x = "PC1 (36.71%)", y = "PC2 (27.11%)")
#Adjusted biplot with dashed ellipse for staminode presence
biplot_PC12 <- ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_hline(yintercept = 0, linetype = "solid", color = "darkgray", size = 1) +
  geom_vline(xintercept = 0, linetype = "solid", color = "darkgray", size = 1) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.08, "inches")), color = "darkgray", size = 2) +
  geom_point(aes(color = Floral_structure, shape = Floral_structure), size = 8) + 
   # Add ellipses with specific line types for staminode presence and absence
  stat_ellipse(aes(color = Floral_structure, linetype = Floral_structure), 
               type = "norm", level = 0.95, linewidth = 1.5) +
  scale_linetype_manual(name = "Floral organ", 
                        values = c("Stamen" = "solid", "Staminode" = "dashed"),
                        labels = c("Stamen", "Staminode")) +
  #geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
  #          vjust = 0.6, hjust = 0.6, color = "black", size = 9, family = "Times New Roman") +
  scale_color_manual(name = "Floral organ", 
                     values = c("Staminode" = "#377EB8", "Stamen" = "darkorange"),
                     labels = c("Stamen", "Staminode")) +
  scale_shape_manual(name = "Floral organ", values = staminode_shapes, 
                     labels = c("Stamen", "Staminode")) +  
  xlim(-16, 21.5) + ylim(-15, 13) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line.x = element_line(color = "black", size = 0.5),  # Add x-axis line
    axis.line.y = element_line(color = "black", size = 0.5),  # Add y-axis line
    axis.ticks = element_line(color = "black", size = 1),  # Add axis ticks in black
    axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 2),
    legend.position = "none",
    axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
    legend.title = element_text(family = "Times New Roman", size = 24, color = "black"),#Axis title style
    axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 22, color = "black")
  ) + labs(x = "PC1 (36.71%)", y = "PC2 (27.11%)") +
  annotate("text", x = min(scores_df$PC1) - 8.5, y = max(scores_df$PC2) + 5.6,
           label = "(b)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")

print(biplot_PC12)
#Save the plot as an SVG file
ggsave(filename = "PCA1_2_Staminode_type_without_taxa_point.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")



########WITH LEGEND#########
# Define the shapes for Stamen and Staminode
#staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  # 16 for circle, 17 for triangle

# Modify the data labels in the dataset for consistency
#scores_df$Staminode_type <- factor(scores_df$Staminode_type, 
                                   #                     levels = c("Absence", "Presence"), 
                                   #                   labels = c("Stamen", "Staminode"))

# Create the PCA biplot
#biplot_PC12 <- ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  # geom_hline(yintercept = 0, linetype = "solid", color = "darkgray", size = 1) +
  # geom_vline(xintercept = 0, linetype = "solid", color = "darkgray", size = 1) +
  # geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               #              arrow = arrow(length = unit(0.08, "inches")), color = "darkgray", size = 2) +
  # geom_point(aes(color = Staminode_type, shape = Staminode_type), size = 8) + 
  # # Add ellipses with specific line types for Stamen and Staminode
  # stat_ellipse(aes(color = Staminode_type, linetype = Staminode_type), 
               #              type = "norm", level = 0.95, linewidth = 1.5) +
  # scale_linetype_manual(name = "Floral trait", 
                        #                       values = c("Stamen" = "solid", "Staminode" = "dashed"),
                        #                       labels = c("Stamen", "Staminode")) +
  #  scale_color_manual(name = "Floral trait", 
                     #                    values = c("Staminode" = "#377EB8", "Stamen" = "darkorange"),
                     #                   labels = c("Stamen", "Staminode")) +
  #  scale_shape_manual(name = "Floral trait", values = staminode_shapes, 
  #                     labels = c("Stamen", "Staminode")) +  
  # xlim(-16, 21.5) + ylim(-15, 13) +
  # theme_minimal() +
  #  theme(
    #   text = element_text(family = "Times New Roman", size = 22, color = "black"),
    #   panel.grid.major = element_blank(),
    #   panel.grid.minor = element_blank(),
    #   axis.line.x = element_line(color = "black", size = 0.5),  # Add x-axis line
    #   axis.line.y = element_line(color = "black", size = 0.5),  # Add y-axis line
    #    axis.ticks = element_line(color = "black", size = 1),  # Add axis ticks in black
    #    axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
    #   axis.line = element_line(color = "black"),
    #   panel.border = element_rect(colour = "black", fill = NA, linewidth = 2),
    #   legend.position = "right",
    #   axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
    #   axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),
    #   legend.text = element_text(family = "Times New Roman", size = 22, color = "black"),
    #   legend.title = element_text(family = "Times New Roman", size = 22, color = "black")  # Match legend title style to text
    #  ) + 
  #  labs(x = "PC1 (36.71%)", y = "PC2 (27.11%)") +
  #  annotate("text", x = min(scores_df$PC1) - 8.5, y = max(scores_df$PC2) + 5.6,
           #          label = "(b)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")

# Print the plot
#print(biplot_PC12)
#ggsave(filename = "this is just for legend for pc scores.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")

################GGPLOT2 pPCA scores for MAS showiness###############
####################################################################
#################EACH SEPARATED PC##################################
####################################################################

#Load necessary library
library(ggplot2)
theme1 <-  theme(
  panel.grid.major = element_blank(),  #Remove major grid lines
  panel.grid.minor = element_blank(),  #Remove minor grid lines
  axis.line.x = element_line(color = "black", size = 0.5),  #Add x-axis line
  axis.line.y = element_line(color = "black", size = 0.5),  #Add y-axis line
  axis.ticks = element_line(color = "black", size = 1),  #Add axis ticks in black
  axis.ticks.length = unit(0.25, "cm"),  # Length of the ticks
  panel.border = element_rect(color = "black", fill = NA, size = 2),  #Add border around the plot
  axis.title = element_text(family = "Times New Roman", size = 22, color = "black"),
  legend.title = element_text(family = "Times New Roman", size = 24, color = "black"),#Axis title style
  axis.text = element_text(family = "Times New Roman", size = 22, color = "black"),  #Axis text style
  legend.text = element_text(family = "Times New Roman", size = 22, color = "black"),
  legend.position = "none"  #Hide the legend
)
#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  #16 for circle, 17 for triangle
#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc1_showiness_plot <- ggplot(cbind_data, aes(x = PC1, y = showiness_res, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  # Set custom shapes
  labs(x = "PC1", y = "Showiness (residuals)") +  # Label the axes
  ylim(-1.6, 1.6) +  # Set the y-axis limits
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC1 (36.71%)") +
  annotate("text", x = min(cbind_data$PC1), y = max(cbind_data$showiness_res) + 0.28,
           label = "(b)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc1_showiness_plot)
#Save the plot as an SVG file
ggsave(filename = "showinesspc1.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")


#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  #16 for circle, 17 for triangle

#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc2_showiness_plot <- ggplot(cbind_data, aes(x = PC2, y = showiness_res, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  #Set custom shapes
  labs(x = "PC2", y = "Showiness (residuals)") +  #Label the axes
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC2 (27.11%)") +
  annotate("text", x = min(cbind_data$PC2), y = max(cbind_data$showiness_res) + 0.05,
           label = "(c)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc2_showiness_plot)
#Save the plot as an SVG file
ggsave(filename = "showinesspc2.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")


#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  #16 for circle, 17 for triangle
#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc3_showiness_plot <- ggplot(cbind_data, aes(x = PC3, y = showiness_res, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  #Set custom shapes
  labs(x = "PC3", y = "Showiness (residuals)") +  #Label the axes
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC3 (14.79%)") +
  annotate("text", x = min(cbind_data$PC3), y = max(cbind_data$showiness_res) + 0.05,
           label = "(d)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc3_showiness_plot)
#Save the plot as an SVG file
ggsave(filename = "showinesspc3.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")



#Load necessary libraries
library(ggplot2)
library(patchwork)
#Create the PCA biplot (using the previously created biplot_PC12)
#Combine the plots using patchwork
#with legend#####
#combined_plot_npp <- (npp_plot | biplot_PC12)
#Print the combined plot
#print(combined_plot_npp)
#Save the combined plot as an SVG file
#ggsave(filename = "combined_plot_npp_with legend.svg", plot = combined_plot_npp, device = "svg", width = 14, height = 6, units = "in")


#without legend#####
combined_plot_npp <- (npp_plot | biplot_PC12)
combined_plot_npp1 <- npp_plot / biplot_PC12  # Use "/" to stack plots vertically
#Print the combined plot
print(combined_plot_npp1)
#Save the combined plot as an SVG file
ggsave(filename = "combined_plot_npp.svg", plot = combined_plot_npp, device = "svg", width = 17, height = 8, units = "in")
ggsave(filename = "combined_plot_npp1.svg", plot = combined_plot_npp1, device = "svg", width = 10, height = 15, units = "in")




#Load necessary libraries
library(ggplot2)
library(patchwork)
#Create the PCA biplot (using the previously created biplot_PC12)
#Combine the plots using patchwork
combined_plot <- (npp_showiness_plot | pc1_showiness_plot) / (pc2_showiness_plot | pc3_showiness_plot)

#Print the combined plot
print(combined_plot)

#Save the combined plot as an SVG file
ggsave(filename = "PCA_combined_plot.svg", plot = combined_plot, device = "svg", width = 14, height = 12, units = "in")





###################GGPLOT2 pPCA scores for Petal size###############
####################################################################
#################EACH SEPARATED PC##################################
####################################################################

#Define the shapes for Staminode presence and absence
staminode_shapes <- c("Stamen" = 16, "Staminode" = 17)  #16 for circle, 17 for triangle
#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc1_petal <- ggplot(cbind_data, aes(x = PC1, y = log_petal_size, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  # Set custom shapes
  labs(x = "PC1", y = "Log petal showiness (mmÂ²)") +  # Label the axes
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC1 (36.71%)") +
  annotate("text", x = min(cbind_data$PC1), y = max(cbind_data$showiness_res) + 6,
           label = "(b)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc1_petal)

#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc2_petal <- ggplot(cbind_data, aes(x = PC2, y = log_petal_size, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  #Set custom shapes
  labs(x = "PC2", y = "Log petal showiness (mmÂ²)") + #Label the axes
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC2 (27.11%)") +
  annotate("text", x = min(cbind_data$PC2), y = max(cbind_data$showiness_res) + 6,
           label = "(c)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc2_petal)

#Create a scatter plot with a regression line, differentiated by Floral_structure with specified colors and shapes
pc3_petal <- ggplot(cbind_data, aes(x = PC3, y = log_petal_size, color = Floral_structure, shape = Floral_structure)) +
  geom_smooth(method = "lm", aes(group = Floral_structure), size = 5, width = 0.2) +  #Add a linear regression line with confidence interval
  geom_point(size = 8) +  #Set the point size
  scale_color_manual(name = "Floral organ", values = c("Staminode" = "#377EB8", "Stamen" = "darkorange")) +  #Custom colors and legend title
  scale_shape_manual(name = "Floral organ", values = staminode_shapes) +  #Set custom shapes
  labs(x = "PC3", y = "Log petal showiness (mmÂ²)") + #Label the axes
  theme_minimal() +  #Apply a minimal theme
  theme1 + labs(x = "PC3 (14.79%)") +
  annotate("text", x = min(cbind_data$PC3), y = max(cbind_data$showiness_res) + 6,
           label = "(d)", hjust = 0, vjust = 1, size = 8, family = "Times New Roman")
#Print the plot
print(pc3_petal)

#Load necessary libraries
library(ggplot2)
library(patchwork)
#Create the PCA biplot (using the previously created biplot_PC12)
#Combine the plots using patchwork
combined_petal <- (npp_petal | pc1_petal) / (pc2_petal | pc3_petal)

#Print the combined plot
print(combined_petal)

#Save the combined plot as an SVG file
ggsave(filename = "combined_petal.svg", plot = combined_petal, device = "svg", width = 14, height = 12, units = "in")

#######multiple correction across the model###############
##########################################################
##Bonferroni Correction
#Number of tests I have
#Average_NPP ~ Staminode_type (PGLS)
#showiness_res ~ Average_NPP + Staminode_type (PGLS)
#pca_df_filtered ~ Staminode_type (PERMANOVA)
#showiness_res ~ PC1 + PC2 + PC3 + Staminode_type (PGLS)
## List of p-values fro each test
p_values <- c(0.7976, 0.305, 0.010, 5e-04, 0.293, 0.827, 0.475, 0.025)
#p_values <- c(0.7976, 0.01023, 5e-04, 0.02505)
#Number of tests
n_tests <- length(p_values)
#Adjusted alpha level using Bonferroni correction
adjusted_alpha <- 0.05 / n_tests
#Apply correction and check which tests are significant
significant <- p_values < adjusted_alpha
#Results
adjusted_alpha
significant


#Holm-Bonferroni method
adjusted_p_values <- p.adjust(p_values, method = "holm")
#Print the adjusted p-values
print(adjusted_p_values)
#Optional: Filter significant results based on a chosen significance level (e.g., 0.05)
significant_results <- adjusted_p_values < 0.05
print(significant_results)
#Print the significant p-values
print(p_values[significant_results])


#Benjamini-Hochberg (FDR) Correction#) I will use this as i have multiple tests plus exploratory studies like phylogeney and permanova
adjusted_p_values <- p.adjust(p_values, method = "BH")
#Print the adjusted p-values
print(adjusted_p_values)

######USE for my Study###########
##############NPP###################
##List of p-values fro each test staminode or stamen or petal and their showiness
p_values <- c(0.153, 0.190, 0.580, 0.000, 0.648)#pANOVA for staminode, staminode showiness, stamen showiness, petal showiness, petal of staminode and stamen
adjusted_p_values <- p.adjust(p_values, method = "BH")
print(adjusted_p_values)

###########Bioclimatic variables###########
p_values1 <- c(0.000, 0.547, 0.697, 0.040, 0.207, 0.218, 0.107, 0.007, 0.255, 0.023, 0.334) #permanova, PC1 to PC3 for staminode showiness, PC1 to PC3 for stamen, and PC1 to PC3 for petal showiness, staminode presence/absence
adjusted_p_values1 <- p.adjust(p_values1, method = "BH")
print(adjusted_p_values1)



#Optional: Filter significant results based on a chosen FDR level (e.g., 0.05)
significant_results <- adjusted_p_values < 0.05
print(significant_results)

#Print the significant p-values
print(p_values[significant_results])


######correct across predictors within the model#####
#####################################################
#PGLS Model 1: NPP ~ Staminode Type
p_npp_staminode <- 0.798
#PGLS Model 2: Showiness ~ NPP + Staminode Type
p_showiness_npp <- 0.310
p_showiness_staminode <- 0.010
#PERMANOVA Model: Environmental Differences (PC1, PC2, PC3) ~ Staminode Type
p_perm_staminode <- 0.0005
#PGLS Model 3: Showiness ~ PC1 + PC2 + PC3 + Staminode Type
p_showiness_pc1 <- 0.017
p_showiness_pc2 <- 0.289
p_showiness_pc3 <- 0.710
p_showiness_staminode_pc <- 0.056

#Combine all p-values from individual predictors across models
all_p_values <- c(p_npp_staminode,
                  p_showiness_npp,
                  p_showiness_staminode,
                  p_perm_staminode,
                  p_showiness_pc1,
                  p_showiness_pc2,
                  p_showiness_pc3,
                  p_showiness_staminode_pc)

#Apply Benjamini-Hochberg correction
adjusted_p_values <- p.adjust(all_p_values, method = "BH")

#Print the adjusted p-values
print(adjusted_p_values)


######correct across predictors accross the modelaltogether#####
#####################################################
p_values <- c(
  0.000, #INTERCEPT NPP effect from PGLS (NPP and Staminode Presence/Absence)
  0.798, #Staminode effect on NPP from PGLS
  0.038, #INTERCETP NPP effect from PGLS (MAS Showiness)
  0.305, #NPP effect from PGLS (MAS Showiness)
  0.010, #Staminode effect from PGLS (MAS Showiness)
  0.090, #INTERCEPT effect from PGLS (PC1, PC2, PC3 on MAS Showiness)
  0.293, #PC1 effect on mas from PGLS
  0.827, #PC2 effect on mas from PGLS
  0.475, #PC3 effect on mas from PGLS
  0.025, #Staminode effect on MAS from PGLS
  0.000, #Intercept effect from PGLMM (Petal Size with NPP and Staminode)
  0.000, #NPP effect on petal size from PGLMM
  0.648, #Staminode effect on petal size from PGLMM
  0.000, #Intercept effect from PGLMM (Petal Size with PC1, PC2, PC3, and Staminode)
  0.007, #PC1 effect from PGLMM
  0.255, #PC2 effect from PGLMM
  0.023, #PC3 effect from PGLMM
  0.334, #Staminode effect from PGLMM
  2e-04  #P-value from PERMANOVA (Staminode_type effect on bioclimatic variables)
)

#Apply the Benjamini-Hochberg correction
adjusted_p_values <- p.adjust(p_values, method = "BH")
#Display the adjusted P-values
adjusted_p_values


p_values1 <- c(
  0.000, #INTERCEPT NPP effect from PGLS (NPP and Staminode Presence/Absence)
  0.798, #Staminode effect on NPP from PGLS
  0.038, #INTERCETP NPP effect from PGLS (MAS Showiness)
  0.305, #NPP effect from PGLS (MAS Showiness)
  0.010, #Staminode effect from PGLS (MAS Showiness)
  0.090, #INTERCEPT effect from PGLS (PC1, PC2, PC3 on MAS Showiness)
  0.293, #PC1 effect on mas from PGLS
  0.827, #PC2 effect on mas from PGLS
  0.475, #PC3 effect on mas from PGLS
  0.025, #Staminode effect on MAS from PGLS
  0.000, #Intercept effect from PGLMM (Petal Size with NPP and Staminode)
  0.000, #NPP effect on petal size from PGLMM
  0.648, #Staminode effect on petal size from PGLMM
  0.000, #Intercept effect from PGLMM (Petal Size with PC1, PC2, PC3, and Staminode)
  0.007, #PC1 effect from PGLMM
  0.255, #PC2 effect from PGLMM
  0.023, #PC3 effect from PGLMM
  0.334, #Staminode effect from PGLMM
  2e-04  #P-value from PERMANOVA (Staminode_type effect on bioclimatic variables)
)
#Apply the Benjamini-Hochberg correction
adjusted_p_values1 <- p.adjust(p_values1, method = "BH")
#Display the adjusted P-values
adjusted_p_values1


#########################################################################
####Calculate the mean and standard error for the entire dataset#########
#########################################################################

mean_showiness <- mean(scores_df$Showiness)
se_showiness <- sd(scores_df$Showiness) / sqrt(nrow(scores_df))

#Print the results for the entire dataset
cat("Mean Showiness (Total):", mean_showiness, "\n")
cat("Standard Error (Total):", se_showiness, "\n")

#####Calculate the mean and standard error for each Staminode_type########
showiness_summary <- scores_df %>%
  group_by(Staminode_type) %>%
  summarise(
    Mean_Showiness = mean(Showiness),
    SE_Showiness = sd(Showiness) / sqrt(n())
  )
#Print the results for each Staminode_type
print(showiness_summary)

#####Calculate the sample size for the entire dataset#######
total_sample_size <- nrow(scores_df)
#Print the sample size for the entire dataset
cat("Sample Size (Total):", total_sample_size, "\n")

######Calculate the sample size for each Staminode_type#####
sample_size_by_staminode <- scores_df %>%
  group_by(Staminode_type) %>%
  summarise(Sample_Size = n())

######Print the sample size for each Staminode_type#######
print(sample_size_by_staminode)












##########BELOW SCRIPTS ARE NOT FOR MANUSCRIPT BUT GOOD FOR PRACTICES######
################################NOT FOR MANUSCRIPT#########################
################################SHOWINESS USING pPCA#######################
###########################################################################


#########################################################################
###########################PGLMM FOR SHOWINES VS PCS AND STAMINODE#######
#########################################################################

#Fit a PGLMM with Habitat_type and Life_history as random effects and Gaussian family
pglmm_model <- pglmm(
  Log_Showiness ~ PC1 + PC2 + PC3 + Staminode_type + (1 | Habitat_type) + (1 | Life_history) ,
  data = model_data,
  family = "gaussian",  #Use Gaussian for normally distributed continuous response variable
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
#Print summary of the model
summary(pglmm_model)


#########################################################################
###########################PGLMM FOR PETAL VS PCS AND STAMINODE#######
#########################################################################
#Fit a PGLMM with Habitat_type and Life_history as random effects and Gaussian family
pglmm_model_petal <- pglmm(
  log_petal_size ~ PC1 + PC2 + PC3 + Staminode_type  + (1 | Habitat_type) + (1 | Life_history) ,
  data = model_data,
  family = "gaussian",  #Use Gaussian for normally distributed continuous response variable
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
#Print summary of the model
summary(pglmm_model_petal)

#########################################################################
###########################PGLMM FOR MAS VS PCS AND STAMINODE#######
#########################################################################
#Fit a PGLMM with Habitat_type and Life_history as random effects and Gaussian family
pglmm_model_mas <- pglmm(
  log_mas_size ~ PC1 + PC2 + PC3 + Staminode_type  + (1 | Habitat_type) + (1 | Life_history),
  data = model_data,
  family = "gaussian",  #Use Gaussian for normally distributed continuous response variable
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
#Print summary of the model
summary(pglmm_model_mas)


#########################################################################
###########################PGLM FOR SHOWINES VS PCS AND STAMINODE########
#########################################################################
pglm_model <- phylolm(
  Log_Showiness ~ PC1 + PC2 + PC3 + Staminode_type,  #Model formula
  data = model_data,                                 #Data frame containing the variables
  phy = tree,                                         #Phylogenetic tree
  model = "BM",                                       #Brownian Motion model for phylogenetic signal
  family = gaussian()                                 #Use Gaussian for log-transformed continuous data
)
#Summary of the model
summary(pglm_model)


#########################################################################
###########################PGLM FOR LIFE HISTORY AND HABITAT TYPE########
#########################################################################

#####Convert Life_history column to binary numeric values###

model_data <- model_data %>%
  mutate(Perennial = ifelse(Life_history == "Perennial", 1, 0))  #"Perennial" to 1, "Non_perennial" to 0
#View the updated data frame
head(model_data)

#Convert Habitat_type column to binary numeric values
model_data <- model_data %>%
  mutate(Habitat = ifelse(Habitat_type == "Gypsum", 1, 0))  #"Gypsum" to 1, "Non_gypsum" to 0
#View the updated data frame
head(model_data)


#######################################################################
################################Gypsum affinity########################
#Fit a PGLMM with Habitat_type as random effect and Gaussian family
pglmm_lifehistory <- pglmm(
  Habitat ~ Staminode_type + (1 | Life_history) ,
  data = model_data,
  family = "binomial",  #Use Gaussian for normally distributed continuous response variable
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
#Print summary of the model
summary(pglmm_lifehistory)


###################################RUN PGLMM#########################
##################################Life history#######################
#binary data (presence and absence)
#Fit a PGLMM with Habitat_type and Life_history as random effects and Gaussian family
pglmm_lifeHistory <- pglmm(
  Perennial ~ Staminode_type + (1 | Habitat_type),
  data = model_data,
  family = "binomial",  #Use Gaussian for normally distributed continuous response variable
  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
)
#Print summary of the model
summary(pglmm_lifeHistory)


################################################################
######################NPP Phylogenetic PGLS ####################NOT FOR MANUSCRIPT
################################################################

#Create a comparative data object
library(caper)
comp_data <- comparative.data(phy = tree, data = npp_data, names.col = "Taxon", vcv = TRUE, na.omit = FALSE)

#Define the PGLS model with Average_NPP as the response variable and Staminode type as the predictor
pgls_model <- pgls(Average_NPP ~ Staminode_type, data = comp_data)
#Print the summary of the PGLS model
summary(pgls_model)

#Diagnostic plots to check residuals
par(mfrow = c(2, 2))  #Adjusts the layout for multiple plots
plot(pgls_model)
#Reset plotting layout
par(mfrow = c(1, 1))



################################################################
#####################PGLMM FOR NPP##############################NOT FOR MANUSCRIPT
################################################################
#Load necessary library
library(phyr)
#Fit a PGLMM with Habitat_type and Life_history as random effects and Gaussian family
#pglmm_model <- pglmm(
 # Log_Showiness ~ Average_NPP * Staminode_type + (1 | Habitat_type) + (1 | Life_history),
 # data = npp_data,
#  family = "gaussian",  #Use Gaussian for normally distributed continuous response variable
#  cov_ranef = list(Taxon = tree)  #Include phylogenetic tree as a random effect
#)
#Print summary of the model
#summary(pglmm_model)

########################################
#############PGLMM FOR PETAL############NOT FOR MANUSCRIPT
########################################
###WITH RANDOM
#Log-transform the petal size
npp_data$log_petal_size <- log(npp_data$petal_size + 1) 
pglmm_model_petal <- pglmm(
  log_petal_size ~ Average_NPP * Staminode_type + (1 | Life_history) + (1 | Habitat_type),  
  data = npp_data,  
  family = "gaussian",  
  cov_ranef = list(Taxon = tree)
)
#Print summary of the model
summary(pglmm_model_petal)


###########PGLMM FOR MAS#############NOT FOR MANUSCRIPT
#####################################
#WITH RANDOM
npp_data$log_mas_size <- log(npp_data$mas_size + 1) 
pglmm_model_MAS <- pglmm(
  log_mas_size ~ Average_NPP * Staminode_type + (1 | Life_history) + (1 | Habitat_type), 
  data = npp_data,  
  family = "gaussian", 
  cov_ranef = list(Taxon = tree) 
)
# Print summary of the model
summary(pglmm_model_MAS)

########################################################
####Check phylogenetic signal for showiness#############
########################################################
#Install and load necessary libraries
library(phytools)
library(geiger)

#Prepare the data
model_data <- scores_df
rownames(model_data) <- model_data$Taxon
#Extract the Showiness trait and the corresponding phylogeny
showiness_trait <- setNames(model_data$Showiness, rownames(model_data))
phylo <- tree

# Log-transform the Showiness trait
showiness_trait <- log(setNames(model_data$Showiness, rownames(model_data)))

#Calculate Pagel's Lambda
lambda_result <- phylosig(phylo, showiness_trait, method = "lambda", test = TRUE)
print(lambda_result)
#Calculate Blomberg's K
k_result <- phylosig(phylo, showiness_trait, method = "K", test = TRUE)
print(k_result)


#Load necessary libraries
library(caper)
library(ape)
library(car)
#Find the minimum value in the Showiness column
min_showiness <- min(scores_df$Showiness, na.rm = TRUE)

#Add a small constant to shift the values if the minimum is less than or equal to zero
#Choose a constant that will ensure all values are positive
constant <- if (min_showiness <= 0) { abs(min_showiness) + 1 } else { 0 }

#Apply the log transformation after adding the constant
scores_df$log_Showiness <- log(scores_df$Showiness + constant)

#Check normality again after transformation
ggplot(scores_df, aes(x = log_Showiness)) +
  geom_histogram(binwidth = 0.5, color = "black", fill = "white") +
  theme_minimal()

qqPlot(scores_df$log_Showiness, main = "Q-Q Plot for Log-Transformed Showiness")

shapiro.test(scores_df$log_Showiness)

#Ensure your tree and data are compatible
comparative_data <- comparative.data(tree, scores_df, names.col = "Taxon", vcv = TRUE, na.omit = TRUE)

pgls_pc_model <- pgls(log_Showiness ~ PC1 + PC2 + PC3, data = comparative_data)
summary(pgls_pc_model)

##################################NOT FOR MANUSCRIPT############################
#####################SHOWINESS USING PGLS AND WITHOUT USING pPCA################
################################################################################
#Load necessary libraries
library(phytools)
library(ape)
library(caper)
library(dplyr)

#Load the CSV file
data <- read.csv("geo_cbind_taxon_env_plus_trait.csv")

#Perform normality tests and apply transformations if needed
env_data <- dplyr::select(data, starts_with("bio"))

#Function to decide transformation based on normality
transform_variable <- function(x) {
  p_value <- shapiro.test(x)$p.value
  if (p_value < 0.05) {
    return(log1p(x - min(x, na.rm = TRUE) + 1)) #Log transformation for non-normal distribution
  } else {
    return(x) #No transformation needed
  }
}

#Apply transformation
transformed_env_data <- env_data %>% mutate(across(everything(), transform_variable))

# Perform PCA on the transformed data (Standardized and centered PCA)
pca_result <- prcomp(transformed_env_data, scale. = TRUE, center = TRUE)

# Create a data frame for the PCA scores (first 3 components)
scores_df <- as.data.frame(pca_result$x[, 1:3])
colnames(scores_df) <- c('PC1', 'PC2', 'PC3')

#Log transform 'Showiness'#data$Showiness_log <- log(data$Showiness)

data$Showiness <- data$Showiness##we dont use log transformation as geometric mean is log-transformed

#Merge the PCA scores with the transformed showiness and Taxon information
merged_data <- cbind(scores_df, data[, c("Taxon", "Showiness")])

#Load the phylogenetic tree
tree <- read.tree("BartoniaIngroupPLnames.tre")

#Ensure your tree and data are compatible
comparative_data <- comparative.data(tree, merged_data, names.col = "Taxon", vcv = TRUE, na.omit = TRUE)

#Run PGLS
pgls_model <- pgls(Showiness ~ PC1 + PC2 + PC3, data = comparative_data)

#Summarize the results
summary(pgls_model)#when i used log transformation pc1 is signigicant



##################################################################
####Generate boxplots for each environmental variable#############
############Not for the paper#####################################
bio_variables <- c("bio1", "bio2", "bio4", "bio8", "bio9", "bio12", "bio14", "bio15", "bio18", "bio21")

###Create a list to store the plots
plots <- list()

###Generate and store the plots in the list
for (bio in bio_variables) {
  plot <- ggplot(data, aes_string(x = "Staminode_type", y = bio, fill = "Staminode_type")) +
    geom_boxplot() +
    theme_minimal() +
    labs(title = paste("Boxplot of", bio, "by Staminode Type"), x = "Staminode Type", y = bio) +
    scale_fill_manual(values = c("Absence" = "darkgreen", "Presence" = "orange")) +
    theme(
      text = element_text(family = "Times New Roman", size = 15),
      axis.title = element_text(family = "Times New Roman", size = 15),
      axis.text = element_text(family = "Times New Roman", size = 12),
      legend.position = "none"
    )
  plots[[bio]] <- plot
}
library(gridExtra)
###Combine all the plots into one
combined_plot <- grid.arrange(grobs = plots, ncol = 3)

###Print the combined plot
print(combined_plot)

###Save the combined plot to a file
#ggsave(filename = "combined_boxplots.tif", plot = combined_plot, width = 20, height = 15, units = "in")

######################################################################
####################PCA without phylogeny#############################
####PERFORMING PCA ON GEOMETRIC MEAN DATASET##########################
# Load necessary libraries
library(ggplot2)
library(tidyr)

# Load the CSV file
data <- read.csv("geo_cbind_taxon_env_plus_trait.csv")
#Perform normality tests and apply transformations if needed
env_data <- dplyr::select(data, starts_with("bio"))

#Dont apply log transformation
pca_result <- prcomp(env_data, scale. = TRUE, center = TRUE)# Standardized and centered PCA
#pca_result <- prcomp(env_data, scale. = FALSE, center = TRUE)# for performing the PCA using the covariance matrix, only center the data, do not scale
#Get summary of PCA result
pca_summary <- summary(pca_result)
# Print the proportion of variance explained by each PC
print(pca_summary$importance)
# Extract the proportion of variance for the first three PCs
proportion_variance <- pca_summary$importance[2, 1:3] * 100
# Print the percentage of variance explained by PC1, PC2, and PC3
cat("Percentage of Variance Explained by PC1:", round(proportion_variance[1], 2), "%\n")
cat("Percentage of Variance Explained by PC2:", round(proportion_variance[2], 2), "%\n")
cat("Percentage of Variance Explained by PC3:", round(proportion_variance[3], 2), "%\n")

#Create a data frame for the variable loadings
loadings_df <- as.data.frame(pca_result$rotation[, 1:3])#Select the first three principal components
# Print the loadings
print(loadings_df)

#Optionally, create a more readable data frame
loadings_df1 <- as.data.frame(loadings_df)
loadings_df1$variable <- rownames(loadings_df1)
print(loadings_df1)
loadings_df$variable <- rownames(pca_result$rotation) #Name the loadings
#Create a data frame for the scores
#Directly select all components instead of just the first three for potential full analysis later
scores_df <- as.data.frame(pca_result$x)  # All principal component scores
#Merge taxon, staminode type, and gypsum type info
scores_df <- cbind(scores_df, data[, c("Taxon", "Staminode_type", "Habitat_type", "Life_history", "petal_size", "mas_size", "Average_NPP")])
#write.csv(scores_df, file = "PC_scores_Mentzelia.csv", row.names = FALSE)

###PERMANOVA for PERENNIAL#####
library(RVAideMemoire)
pca_df_filtered <- scores_df[,1:3]
pca_perm <-adonis2(pca_df_filtered~ Staminode_type * Life_history * Habitat_type, 
                   data=scores_df, permutations = 9999, method = "euclidean")
pca_perm
pairwise.perm.manova(dist(pca_df_filtered,"euclidean"),scores_df$Perennial,nperm=9999, p.method = "none")
pairwise.perm.manova(dist(pca_df_filtered,"euclidean"),scores_df$Staminode_type,nperm=9999, p.method = "none")
pairwise.perm.manova(dist(pca_df_filtered,"euclidean"),scores_df$Gypsum_type,nperm=9999, p.method = "none")

################################################
##########PLOTTING STAMINODE TYPE###############
################################################
#Define the environmental variable names
bio_variable_names <- c(
  "bio1" = "Annual Mean Temperature",
  "bio2" = "Mean Diurnal Range",
  "bio3" = "Isothermality",
  "bio4" = "Temperature Seasonality",
  "bio5" = "Max Temperature of Warmest Month",
  "bio6" = "Min Temperature of Coldest Month",
  "bio7" = "Temperature Annual Range",
  "bio8" = "Mean Temperature of Wettest Quarter",
  "bio9" = "Mean Temperature of Driest Quarter",
  "bio10" = "Mean Temperature of Warmest Quarter",
  "bio11" = "Mean Temperature of Coldest Quarter",
  "bio12" = "Annual Precipitation",
  "bio13" = "Precipitation of Wettest Month",
  "bio14" = "Precipitation of Driest Month",
  "bio15" = "Precipitation Seasonality",
  "bio16" = "Precipitation of Wettest Quarter",
  "bio17" = "Precipitation of Driest Quarter",
  "bio18" = "Precipitation of Warmest Quarter",
  "bio19" = "Precipitation of Coldest Quarter",
  "bio20" = "Solar Radiation",
  "bio21" = "Elevation"
)

#Apply the named vector to the row names of the loadings data frame
loadings_df$variable <- bio_variable_names[rownames(loadings_df)]

#Scaling factor for the loadings, adjust this as needed
#scaling_factor <- 7  # Adjust this scaling factor as appropriate for the plot
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC2))) / max(abs(c(loadings_df$PC1, loadings_df$PC2))) * 0.8

#Create a PCA1 and PC2 biplot with ggplot2
staminode_shapes <- c("Absence" = 16, "Presence" = 17)  # 16 for circle, 17 for triangle
library(ggplot2)


###Create the first biplot with label "A"
biplot_PC12 <- ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1) +
  geom_point(aes(color = Staminode_type, shape = Staminode_type), size = 5) + 
  stat_ellipse(aes(color = Staminode_type), type = "norm", level = 0.95, linewidth = 1.5)+
  scale_linetype_manual(name = "Staminode", values = c("Absence" = "dashed", "Presence" = "solid"),
                        labels = c("Absence", "Presence")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 4, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Staminode", values = c("Presence" = "orange", "Absence" = "darkgreen"),
                     labels = c("Absence", "Presence")) +
  scale_shape_manual(name = "Staminode", values = staminode_shapes, 
                     labels = c("Absence", "Presence")) +  
  xlim(-7, 6) + ylim(-5.8, 4) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 20, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 15, color = "black")
  ) + labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"))
 # annotate("text", x = -5.5, y = 4, label = "A", size = 6, family = "Times New Roman")

print(biplot_PC12)

#Save the plot as an SVG file
ggsave(filename = "PCA1_2_Staminode_type_without_taxa_point.svg", plot = biplot_PC12, device = "svg", width = 9, height = 7, units = "in")

###########################################################
#####################TAXA on PC1 and PC2####################
############################################################

# Create a PCA1 and PC2 biplot with ggplot2
biplot_PC_taxa <- ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1) +
  geom_text(aes(label = Taxon, color = Staminode_type), size = 3) + 
  stat_ellipse(aes(color = Staminode_type), type = "norm", level = 0.95, linewidth = 1.5) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 4, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Staminode", values = c("Presence" = "red", "Absence" = "darkgreen"),
                     labels = c("Absence", "Presence")) +
  xlim(-7, 6) + ylim(-5.8, 4) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 20, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 15, color = "black")
  ) +
  labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"))

print(biplot_PC_taxa)

#Save the plot as an SVG file
ggsave(filename = "PCA1_2_Staminode_type_with_taxa_names.svg", plot = biplot_PC_taxa, device = "svg", width = 9, height = 7, units = "in")




####################################
###########ggplot with no############
# Required libraries
library(ggplot2)
library(grid)

# Example dataset for illustration
scores_df <- data.frame(
  PC1 = rnorm(100),
  PC2 = rnorm(100),
  Staminode_type = sample(c("Presence", "Absence"), 100, replace = TRUE)
)

loadings_df <- data.frame(
  PC1 = runif(10, -1, 1),
  PC2 = runif(10, -1, 1),
  variable = paste("Var", 1:10)
)

scaling_factor <- 1  # Adjust as needed
staminode_shapes <- c("Presence" = 16, "Absence" = 17)

# PCA result placeholder for illustration
pca_result <- list(sdev = c(1.5, 1.0, 0.5))

# Creating the biplot
biplot_PC12 <- ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", linewidth = 1) +
  geom_point(aes(color = Staminode_type, shape = Staminode_type), size = 5) + 
  stat_ellipse(aes(color = Staminode_type, linetype = Staminode_type), type = "norm", level = 0.95, linewidth = 1) +
  scale_linetype_manual(name = "Staminode type", values = c("Absence" = "dashed", "Presence" = "solid"),
                        labels = c("Absence", "Presence")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 4, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Staminode type", values = c("Presence" = "red", "Absence" = "darkgreen"),
                     labels = c("Absence", "Presence")) +
  scale_shape_manual(name = "Staminode type", values = staminode_shapes, 
                     labels = c("Absence", "Presence")) +  
  xlim(-5.8, 5) + ylim(-4.8, 4) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 15, color = "black")
  ) + labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
           y = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -5.5, y = 4, label = "A", size = 6, family = "Times New Roman")

print(biplot_PC12)









loadings_df

##########################################################################
#################################PC1 to PC3###############################
##########################################################################
scaling_factor <- max(abs(c(loadings_df$PC1, loadings_df$PC3))) / max(abs(c(loadings_df$PC1, loadings_df$PC3))) * 0.8

#Create a PCA1 and PC2 biplot with ggplot2
staminode_shapes <- c("Absence" = 16, "Presence" = 17)  # 16 for circle, 17 for triangle
# Create the first biplot with label "A"
biplot_PC13 <- ggplot(data = scores_df, aes(x = PC1, y = PC3)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC3 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Staminode_type, shape = Staminode_type), size = 5) + 
  stat_ellipse(aes(color = Staminode_type, linetype = Staminode_type), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Staminode type", values = c("Absence" = "dashed", "Presence" = "solid"),
                        labels = c("Absence", "Presence")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC3 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 4, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Staminode type", values = c("Presence" = "orange", "Absence" = "darkgreen"),
                     labels = c("Absence", "Presence")) +
  scale_shape_manual(name = "Staminode type", values = staminode_shapes, 
                     labels = c("Absence", "Presence")) +  
  xlim(-5.8, 5) + ylim(-4.8, 4) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 20, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 20, color = "black")
  ) + labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
           y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -5.5, y = 4, label = "B", size = 6, family = "Times New Roman")

print(biplot_PC13)

#Save the plot as an SVG file
#ggsave(filename = "PCA1_2_Staminode_type.svg", plot = biplot, device = "svg", width = 8, height = 6, units = "in")
ggsave(filename = "PCA1_3_Staminode_type_without_A.svg", plot = biplot_PC13, device = "svg", width = 9, height = 7, units = "in")


##########################################################################
#################################PC2 to PC3###############################
##########################################################################
scaling_factor <- max(abs(c(scores_df$PC2, scores_df$PC3))) / max(abs(c(loadings_df$PC1, loadings_df$PC3))) * 0.8
staminode_shapes <- c("Absence" = 16, "Presence" = 17)  # 16 for circle, 17 for triangle
# Create the first biplot with label "A"
biplot_PC23 <- ggplot(data = scores_df, aes(x = PC2, y = PC3)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC2 * scaling_factor, yend = PC3 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Staminode_type, shape = Staminode_type), size = 5) + 
  stat_ellipse(aes(color = Staminode_type, linetype = Staminode_type), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Staminode type", values = c("Absence" = "dashed", "Presence" = "solid"),
                        labels = c("Absence", "Presence")) +
  geom_text(data = loadings_df, aes(x = PC2 * scaling_factor, y = PC3 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 4, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Staminode type", values = c("Presence" = "orange", "Absence" = "darkgreen"),
                     labels = c("Absence", "Presence")) +
  scale_shape_manual(name = "Staminode type", values = staminode_shapes, 
                     labels = c("Absence", "Presence")) +  
  xlim(-5.5, 5) + ylim(-4.8, 4) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 20, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 20, color = "black")
  ) + labs(x = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
           y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -5.5, y = 4, label = "C", size = 6, family = "Times New Roman")

print(biplot_PC23)

#Save the plot as an SVG file
ggsave(filename = "PCA2_3_Staminode_type_without_A.svg", plot = biplot_PC23, device = "svg", width = 9, height = 7, units = "in")


library(cowplot)
library(ggplot2)

# Combine the two plots with equal heights
staminode_pc123 <- plot_grid(biplot_PC12, biplot_PC13, biplot_PC23, ncol = 1, align = "v", rel_heights = c(1, 1, 1))

# Print the combined plot
print(staminode_pc123)

# Save the combined plot as an SVG file
ggsave(filename = "Staminode_PC123.svg", plot = staminode_pc123, device = "svg", width = 9, height = 19, units = "in")




##########################################
##########PLOTTING LIFE FORM ###############
#################PC1 TO 2#######################
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC2))) / max(abs(c(loadings_df$PC1, loadings_df$PC2))) * 0.8
#Create a new column without underscores in Non_perennial
scores_df$Life_history_clean <- gsub("_", " ", scores_df$Life_history)

life_history_shapes <- c("Non perennial" = 16, "Perennial" = 17)  # 16 for circle, 17 for triangle

lbiplot_PC12 <-  ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Life_history_clean, shape = Life_history_clean), size = 6) + 
  stat_ellipse(aes(color = Life_history_clean, linetype = Life_history_clean), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Life history", values = c("Non perennial" = "dashed", "Perennial" = "solid"),
                        labels = c("Non perennial", "Perennial")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Life history", values = c("Perennial" = "orange", "Non perennial" = "darkgreen"),
                     labels = c("Non perennial", "Perennial")) +
  scale_shape_manual(name = "Life history", values = life_history_shapes, 
                     labels = c("Non perennial", "Perennial")) +  
  xlim(-7, 5.5) + ylim(-5, 4.5) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 18, color = "black")
  ) +
labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
     y = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
 annotate("text", x = -6.9, y = 4.5, label = "A", size = 8, family = "Times New Roman")

print(lbiplot_PC12)
#Save the plot as an SVG file
ggsave(filename = "PCA_1_2_Perennial.svg", plot = lbiplot_PC12, device = "svg", width = 8, height = 6, units = "in")

##########PLOTTING LIFE FORM ###############
#################PC1 TO 3#######################
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC3))) / max(abs(c(loadings_df$PC1, loadings_df$PC3))) * 0.8
#Create a new column without underscores in Non_perennial
scores_df$Life_history_clean <- gsub("_", " ", scores_df$Life_history)

life_history_shapes <- c("Non perennial" = 16, "Perennial" = 17)  # 16 for circle, 17 for triangle

lbiplot_PC13 <-  ggplot(data = scores_df, aes(x = PC1, y = PC3)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC3 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Life_history_clean, shape = Life_history_clean), size = 6) + 
  stat_ellipse(aes(color = Life_history_clean, linetype = Life_history_clean), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Life history", values = c("Non perennial" = "dashed", "Perennial" = "solid"),
                        labels = c("Non perennial", "Perennial")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC3 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Life history", values = c("Perennial" = "orange", "Non perennial" = "darkgreen"),
                     labels = c("Non perennial", "Perennial")) +
  scale_shape_manual(name = "Life history", values = life_history_shapes, 
                     labels = c("Non perennial", "Perennial")) +  
  xlim(-7, 5.5) + ylim(-5, 4.5) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 18, color = "black")
  ) +
  labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -6.9, y = 4.5, label = "B", size = 8, family = "Times New Roman")

print(lbiplot_PC13)
#Save the plot as an SVG file
ggsave(filename = "PCA_1_3_Perennial.svg", plot = lbiplot_PC13, device = "svg", width = 8, height = 6, units = "in")


##########PLOTTING LIFE FORM ###############
#################PC2 TO 3#######################
scaling_factor <- max(abs(c(scores_df$PC2, scores_df$PC3))) / max(abs(c(loadings_df$PC2, loadings_df$PC3))) * 0.8
#Create a new column without underscores in Non_perennial
scores_df$Life_history_clean <- gsub("_", " ", scores_df$Life_history)

life_history_shapes <- c("Non perennial" = 16, "Perennial" = 17)  # 16 for circle, 17 for triangle

lbiplot_PC23 <-  ggplot(data = scores_df, aes(x = PC3, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC3 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Life_history_clean, shape = Life_history_clean), size = 6) + 
  stat_ellipse(aes(color = Life_history_clean, linetype = Life_history_clean), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Life history", values = c("Non perennial" = "dashed", "Perennial" = "solid"),
                        labels = c("Non perennial", "Perennial")) +
  geom_text(data = loadings_df, aes(x = PC3 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "solid", color = "black") +
  scale_color_manual(name = "Life history", values = c("Perennial" = "orange", "Non perennial" = "darkgreen"),
                     labels = c("Non perennial", "Perennial")) +
  scale_shape_manual(name = "Life history", values = life_history_shapes, 
                     labels = c("Non perennial", "Perennial")) +  
  xlim(-7, 5.5) + ylim(-5, 4.5) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 18, color = "black")
  ) +
  labs(x = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -6.9, y = 4.5, label = "C", size = 8, family = "Times New Roman")

print(lbiplot_PC23)
#Save the plot as an SVG file
ggsave(filename = "PCA_1_2_Perennial.svg", plot = lbiplot_PC23, device = "svg", width = 8, height = 6, units = "in")

##########gypsum type ###############
###############pc1 TO 2#########################
#Create a new column without underscores in Non_perennial
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC2))) / max(abs(c(loadings_df$PC1, loadings_df$PC2))) * 0.8
scores_df$Hibat_type_clean <- gsub("_", " ", scores_df$Habitat_type)

habitat_shapes <- c("Gypsum" = 16, "Non gypsum" = 17)  # 16 for circle, 17 for triangle

gbiplot_PC12 <-  ggplot(data = scores_df, aes(x = PC1, y = PC2)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC2 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1) +
  geom_point(aes(color = Hibat_type_clean, shape = Hibat_type_clean), size = 5) + 
  stat_ellipse(aes(color = Hibat_type_clean, linetype = Hibat_type_clean), level = 0.95, size = 1) +
  scale_linetype_manual(name = "Habitat type", values = c("Non gypsum" = "solid", "Gypsum" = "dashed"),
                        labels = c("Non gypsum", "Gypsum")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC2 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(name = "Habitat type", values = c("Gypsum" = "darkgreen", "Non gypsum" = "orange"),
                     labels = c("Non gypsum", "Gypsum")) +
  scale_shape_manual(name = "Habitat type", values = habitat_shapes, 
                     labels = c("Non gypsum", "Gypsum")) +  
  xlim(-5.5, 5.5) + ylim(-4.7, 4.8) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 15, color = "black")
  ) +
  labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) 
  #annotate("text", x = -6.9, y = 4.8, label = "D", size = 8, family = "Times New Roman")

print(gbiplot_PC12)
#Save the plot as an SVG file
ggsave(filename = "PCA_1_2_gypsum.svg", plot = gbiplot_PC12, device = "svg", width = 8, height = 6, units = "in")

##########gypsum type ###############
###############pc1 TO 3#########################
#Create a new column without underscores in Non_perennial
scaling_factor <- max(abs(c(scores_df$PC1, scores_df$PC3))) / max(abs(c(loadings_df$PC1, loadings_df$PC3))) * 0.8
scores_df$Hibat_type_clean <- gsub("_", " ", scores_df$Habitat_type)

habitat_shapes <- c("Gypsum" = 16, "Non gypsum" = 17)  # 16 for circle, 17 for triangle

gbiplot_PC13 <-  ggplot(data = scores_df, aes(x = PC1, y = PC3)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * scaling_factor, yend = PC3 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Hibat_type_clean, shape = Hibat_type_clean), size = 6) + 
  stat_ellipse(aes(color = Hibat_type_clean, linetype = Hibat_type_clean), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Habitat type", values = c("Non gypsum" = "solid", "Gypsum" = "dashed"),
                        labels = c("Non gypsum", "Gypsum")) +
  geom_text(data = loadings_df, aes(x = PC1 * scaling_factor, y = PC3 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(name = "Habitat type", values = c("Gypsum" = "darkgreen", "Non gypsum" = "orange"),
                     labels = c("Non gypsum", "Gypsum")) +
  scale_shape_manual(name = "Habitat type", values = habitat_shapes, 
                     labels = c("Non gypsum", "Gypsum")) +  
  xlim(-7, 6) + ylim(-4.7, 4.8) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 18, color = "black")
  ) +
  labs(x = paste0("PC1 (", round(pca_result$sdev[1]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -6.9, y = 4.8, label = "E", size = 8, family = "Times New Roman")

print(gbiplot_PC13)
#Save the plot as an SVG file
ggsave(filename = "PCA_1_3_gypsum.svg", plot = gbiplot_PC13, device = "svg", width = 8, height = 6, units = "in")


##########gypsum type ###############
###############pc2 TO 3#########################
#Create a new column without underscores in Non_perennial
scaling_factor <- max(abs(c(scores_df$PC2, scores_df$PC3))) / max(abs(c(loadings_df$PC2, loadings_df$PC3))) * 0.8
scores_df$Hibat_type_clean <- gsub("_", " ", scores_df$Habitat_type)

habitat_shapes <- c("Gypsum" = 16, "Non gypsum" = 17)  # 16 for circle, 17 for triangle

gbiplot_PC23 <-  ggplot(data = scores_df, aes(x = PC2, y = PC3)) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC2 * scaling_factor, yend = PC3 * scaling_factor),
               arrow = arrow(length = unit(0.05, "inches")), color = "darkgray", size = 1.5) +
  geom_point(aes(color = Hibat_type_clean, shape = Hibat_type_clean), size = 6) + 
  stat_ellipse(aes(color = Hibat_type_clean, linetype = Hibat_type_clean), level = 0.95, size = 1.5) +
  scale_linetype_manual(name = "Habitat type", values = c("Non gypsum" = "solid", "Gypsum" = "dashed"),
                        labels = c("Non gypsum", "Gypsum")) +
  geom_text(data = loadings_df, aes(x = PC2 * scaling_factor, y = PC3 * scaling_factor, label = variable), 
            vjust = 0.6, hjust = 0.6, color = "black", size = 3.5, family = "Times New Roman") +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  scale_color_manual(name = "Habitat type", values = c("Gypsum" = "darkgreen", "Non gypsum" = "orange"),
                     labels = c("Non gypsum", "Gypsum")) +
  scale_shape_manual(name = "Habitat type", values = habitat_shapes, 
                     labels = c("Non gypsum", "Gypsum")) +  
  xlim(-7, 6) + ylim(-4.7, 4.8) +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 22, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "Times New Roman", size = 20, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 20, color = "black"),
    legend.text = element_text(family = "Times New Roman", size = 18, color = "black")
  ) +
  labs(x = paste0("PC2 (", round(pca_result$sdev[2]^2 / sum(pca_result$sdev^2) * 100, 2), "%)"),
       y = paste0("PC3 (", round(pca_result$sdev[3]^2 / sum(pca_result$sdev^2) * 100, 2), "%)")) +
  annotate("text", x = -6.9, y = 4.8, label = "F", size = 8, family = "Times New Roman")

print(gbiplot_PC23)
#Save the plot as an SVG file
ggsave(filename = "PCA_2_3_gypsum.svg", plot = gbiplot_PC23, device = "svg", width = 8, height = 6, units = "in")



library(cowplot)
library(ggplot2)

# Combine the plots into a 3x2 grid with equal heights
pere_gyp_PC123 <- plot_grid(
  lbiplot_PC12, gbiplot_PC12,
  lbiplot_PC13, gbiplot_PC13,
  lbiplot_PC23, gbiplot_PC23,
  ncol = 2, nrow = 3,
  align = "v", rel_heights = c(1, 1, 1)
)

# Print the combined plot
print(pere_gyp_PC123)

# Save the combined plot as an SVG file
ggsave(filename = "Perennial_gypsumPC123.svg", plot = pere_gyp_PC123, device = "svg", width = 17, height = 17, units = "in")



library(ggplot2)
library(cowplot)

# Adjusting the theme for consistent legend placement
biplot1 <- biplot1 + 
  theme(
    legend.position = "right",
    legend.justification = "center",
    legend.box = "vertical"
  )

biplot2 <- biplot2 + 
  theme(
    legend.position = "right",
    legend.justification = "center",
    legend.box = "vertical"
  )

# Combine the two plots with equal heights
combined_plot <- plot_grid(biplot1, biplot2, ncol = 1, align = "v", rel_heights = c(1, 1))

# Print the combined plot
print(combined_plot)
# Save the combined plot as an SVG file
ggsave(filename = "perennial_gypsum.svg", plot = combined_plot, device = "svg", width = 8, height = 9, units = "in")





# Load necessary libraries
library(ggplot2)
library(tidyr)

# Load the CSV file
data <- read.csv("geo_cbind_taxon_env_plus_trait.csv")

# Define the environmental variable names
bio_variable_names <- c(
  "bio1" = "Annual Mean Temperature",
  "bio2" = "Mean Diurnal Range",
  "bio4" = "Temperature Seasonality",
  "bio8" = "Mean Temperature of Wettest Quarter",
  "bio9" = "Mean Temperature of Driest Quarter",
  "bio12" = "Annual Precipitation",
  "bio14" = "Precipitation of Driest Month",
  "bio15" = "Precipitation Seasonality",
  "bio18" = "Precipitation of Warmest Quarter",
  "bio21" = "Elevation"
)

# Generate boxplots
svg("boxplots_for_staminode_type.svg", width=14, height=10)

par(mfrow=c(3,4), mar=c(4,4,2,1))  # Adjust layout

for (var in names(bio_variable_names)) {
  boxplot(data[[var]] ~ data$Staminode_type,
          main=bio_variable_names[var],
          xlab="Staminode Type",
          ylab="",
          col=c("darkgreen", "orange"))
}

# Close the SVG device
dev.off()

svg("boxplots_for_perennial.svg", width=14, height=10)
# Generate boxplots
par(mfrow=c(3,4), mar=c(4,4,2,1))  # Adjust layout

for (var in names(bio_variable_names)) {
  boxplot(data[[var]] ~ data$Perennial,
          main=bio_variable_names[var],
          xlab="Staminode Type",
          ylab="",
          col=c("darkgreen", "orange"))
}
dev.off()

#########################################
####PGLS for NPP, PETAL, and MAS#########
#########################################
#Load necessary libraries
library(ape)# For phylogenetic analysis
library(caper)# For comparative analysis including PGLS

##Data preparation
pca1 <- scores_df[,1]
#Combine pca scores with taxon and petal size
petal <- cbind(pca1, scores_df[, c("Taxon","Showiness", "Staminode_type", "Average_NPP")])

####Phylogenetic Tree Preparation
#load the phylogenetic tree
tree <- read.tree("BartoniaIngroupPLnames.tre")
plot(tree)#see warning: there are NAs

#Check for NA branch lengths and assign a default value if any NAs are found
if(any(is.na(tree$edge.length))) {
  cat("NA branch lengths found. Assigning default length of 1 to all NA branches.\n")
  tree$edge.length[is.na(tree$edge.length)] <- 1
} else {
  cat("No NA branch lengths found.\n")
}
#Check for matching taxa between the tree and the dataset
library(geiger)

name.check(tree, data$Taxon)

#Prepare the comparative data object for caper
comp_data <- comparative.data(tree, data, "Taxon")#There are duplicated between tips and nodes in phylogeny

####Check and Prepare Taxa and Labels
#Ensure tip labels in the tree are unique and match the taxa in the data
tree$tip.label <- make.unique(as.character(tree$tip.label))
data$Taxon <- make.unique(as.character(data$Taxon))

#Find and report unmatched taxa between the data and the tree
data_not_in_tree <- setdiff(data$Taxon, tree$tip.label)
if (length(data_not_in_tree) > 0) {
  cat("Taxa in the data but not in the tree:\n")
  print(data_not_in_tree)
} else {
  cat("All data taxa have a match in the tree.\n")
}

tree_not_in_data <- setdiff(tree$tip.label, data$Taxon)
if (length(tree_not_in_data) > 0) {
  cat("\nTaxa in the tree but not in the data:\n")
  print(tree_not_in_data)
} else {
  cat("\nAll tree taxa have a match in the data.\n")
}


#Address duplicated labels between tips and nodes
all_labels <- c(tree$tip.label, tree$node.label)
duplicated_labels <- all_labels[duplicated(all_labels)]
if(length(duplicated_labels) > 0) {
  tree$node.label <- make.unique(tree$node.label)
  cat("Duplicated labels in the tree were made unique.\n")
} else {
  cat("No duplicated labels found between tips and nodes.\n")
}

####Comparative Data Object Preparation:PGLS Analysis ####
####PCA1#####
comp_data <- comparative.data(tree, data, "Taxon")

####npp
#check normality###
hist(petal$Average_NPP, probability = TRUE, main = "Histogram for NPP")
hist(log(petal$Average_NPP), probability = TRUE, main = "Log histogram for NPP")

# Shapiro-Wilk test for NPP
shapiro_test_original <- shapiro.test(petal$Average_NPP)
print(shapiro_test_original)

# Shapiro-Wilk test for log-transformed NPP
shapiro_test_log <- shapiro.test(log(petal$Average_NPP))
print(shapiro_test_log)

# Q-Q plot for NPP
qqnorm(petal$Average_NPP, main = "Q-Q Plot for NPP")
qqline(petal$Average_NPP, col = "blue")

# Q-Q plot for log-transformed NPP
qqnorm(log(petal$Average_NPP), main = "Q-Q Plot for Log-transformed NPP")
qqline(log(petal$Average_NPP), col = "blue")

#run pgls
pgls_npp <- pgls(Average_NPP ~ Staminode_type, data = comp_data)
summary(pgls_npp)

# Boxplot for NPP by Staminode type
ggplot(data, aes(x = factor(Staminode_type, levels = c("Absence", "Presence")), y = Average_NPP)) +
  geom_boxplot(fill = "gray") +
  labs(title = "PGLS: P = 0.7976", x = "Staminode type", y = "NPP") +
  theme_minimal()

####petal
#check normality###
hist(petal$petal_size, probability = TRUE, main = "Histogram for Petal Size")
hist(log(petal$petal_size), probability = TRUE, main = "Log histogram for Petal Size")

#run pgls
pgls_petal <- pgls(log(petal_size) ~ pca1, data = comp_data)
summary(pgls_petal)

#add a simple linear regression line
abline(lm(log(petal_size) ~ pca1, data = petal), col = "black")
# Create the plot with the specified customizations
pc1_petal <- ggplot(petal, aes(x = pca1, y = log(petal_size))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC1", y = "Log mean petal size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  ) +
  annotate("text", x = -Inf, y = Inf, label = "A", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")

#Print the plot
print(pc1_petal)

#####mas
#check normality
hist(petal$mas_size, probability = TRUE, main = "Histogram for MAS Size")
hist(log(petal$mas_size), probability = TRUE, main = "Log histogram for MAS Size")

pgls_mas <- pgls(log(mas_size) ~ pca1, data = comp_data)
summary(pgls_mas)

#add a simple linear regression line
abline(lm(log(mas_size) ~ pca1, data = petal), col = "black")
#plot using ggplot
library(ggplot2)
pc1_mas <- ggplot(petal, aes(x = pca1, y = log(mas_size))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC1", y = "Log mean MAS size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  )+
  annotate("text", x = -Inf, y = Inf, label =  "B", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")


print(pc1_mas)

####PCA2#####
##Data preparation
pca2 <- scores_df[,2]
#Combine pca scores with taxon and petal size
petal <- cbind(pca2, scores_df[, c("Taxon","petal_size", "mas_size")])

####petal
#check normality###
hist(petal$petal_size, probability = TRUE, main = "Histogram for Petal Size")
hist(log(petal$petal_size), probability = TRUE, main = "Log histogram for Petal Size")

#run pgls
pgls_petal_pca2 <- pgls(log(petal_size) ~ pca2, data = comp_data)
summary(pgls_petal_pca2)

#add a simple linear regression line
abline(lm(log(petal_size) ~ pca2, data = petal), col = "black")
#plot using ggplot
library(ggplot2)
pc2_petal <- ggplot(petal, aes(x = pca2, y = (log(petal_size)))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC2", y = "Log mean petal size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  )+
  annotate("text", x = -Inf, y = Inf, label = "C", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")

print(pc2_petal)

#####mas
#check normality
hist(petal$mas_size, probability = TRUE, main = "Histogram for MAS Size")
hist(log(petal$mas_size), probability = TRUE, main = "Log histogram for MAS Size")

pgls_mas_pca2 <- pgls(log(mas_size) ~ pca2, data = comp_data)
summary(pgls_mas_pca2)

#add a simple linear regression line
abline(lm(log(mas_size) ~ pca2, data = petal), col = "black")
#plot using ggplot


pc2_mas <- ggplot(petal, aes(x = pca2, y = log(mas_size))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC2", y = "Log mean MAS size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  )+
  annotate("text", x = -Inf, y = Inf, label = "D", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")
print(pc2_mas)





####PCA3#####
##Data preparation
pca3 <- scores_df[,3]
#Combine pca scores with taxon and petal size
petal <- cbind(pca3, scores_df[, c("Taxon","petal_size", "mas_size")])

####petal
#check normality###
hist(petal$petal_size, probability = TRUE, main = "Histogram for Petal Size")
hist(log(petal$petal_size), probability = TRUE, main = "Log histogram for Petal Size")

#run pgls
pgls_petal_pca3 <- pgls(log(petal_size) ~ pca3, data = comp_data)
summary(pgls_petal_pca3)

#add a simple linear regression line
abline(lm(log(petal_size) ~ pca3, data = petal), col = "black")
#plot using ggplot
library(ggplot2)
pc3_petal <- ggplot(petal, aes(x = pca3, y = (log(petal_size)))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC3", y = "Log mean petal size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  )+
  annotate("text", x = -Inf, y = Inf, label = "E", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")

print(pc3_petal)

#####mas
#check normality
hist(petal$mas_size, probability = TRUE, main = "Histogram for MAS Size")
hist(log(petal$mas_size), probability = TRUE, main = "Log histogram for MAS Size")

pgls_mas_pca3 <- pgls(log(mas_size) ~ pca3, data = comp_data)
summary(pgls_mas_pca3)

#add a simple linear regression line
abline(lm(log(mas_size) ~ pca3, data = petal), col = "black")
#plot using ggplot


pc3_mas <- ggplot(petal, aes(x = pca3, y = log(mas_size))) +
  geom_smooth(method = "lm", color = "black") +
  geom_point(color = "black", size = 3) +
  labs(x = "PC3", y = "Log mean MAS size (mm)") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman", size = 15),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
    axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
  )+
  annotate("text", x = -Inf, y = Inf, label = "F", 
           hjust = -1, vjust = 2, size = 6, family = "Times New Roman")
print(pc3_mas)

#Combine plots into one figure with labels A, B, C, D
#combined_plot <- grid.arrange(
#  pc1_petal + ggtitle("A"),
#  pc1_mas + ggtitle("B"),
#  pc2_petal + ggtitle("C"),
#  pc2_mas + ggtitle("D"),
#  ncol = 2, nrow = 2
#)
library(gridExtra)
#Combine plots into one figure with labels A, B, C, D
combined <- grid.arrange(
  pc1_petal, pc2_petal,pc3_petal, 
  pc1_mas,
  pc2_mas,
   pc3_mas,
  ncol = 3, nrow = 2
)
print(combined)
ggsave(filename = "combined_plot_petal_mas.svg", plot = combined,
       device = "svg", width = 10, height = 6, bg = "white", units = "in")


#Log transform the petal_size and mas_size
petal$log_petal_size <- log(petal$petal_size)
petal$log_mas_size <- log(petal$mas_size)
# Perform linear regression to obtain correlation and p-value
lm_model <- lm(log_mas_size ~ log_petal_size, data = petal)
lm_summary <- summary(lm_model)
lm_summary
# Extract residuals from the model
residuals_data <- data.frame(residuals = residuals(lm_model))

# Create the density plot for residuals with a vertical line at zero
residual_density_plot <- ggplot(residuals_data, aes(x = residuals)) +
  geom_density(fill = "black", alpha = 0.5) +
  geom_vline(xintercept = 0, color = "black", linetype = "solid") +
  labs(x = "Residuals", y = "Density") +
  theme_minimal()+

theme(
  text = element_text(family = "Times New Roman", size = 15),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.line = element_line(color = "black"),
  panel.border = element_rect(color = "black", fill = NA, size = 0.5),
  axis.title = element_text(family = "Times New Roman", size = 15, color = "black"),
  axis.text = element_text(family = "Times New Roman", size = 15, color = "black")
)
 # annotate("text", x = -Inf, y = Inf, label = "D", 
 #          hjust = -1, vjust = 2, size = 6, family = "Times New Roman")

# Print the plot
print(residual_density_plot)

# Save the plot as SVG
ggsave("residual_density_plot.svg", plot = residual_density_plot, device = "svg", bg = "white")


correlation <- cor(petal$log_petal_size, petal$log_mas_size, method = "pearson")
p_value <- lm_summary$coefficients[2, 4] # p-value for the slope coefficient

print(paste("Correlation between log-transformed petal size and MAS size:", correlation))
print(paste("P-value:", p_value))





########### dont use the one below for manuscript#####

#Calculate the correlation
correlation <- cor(petal$log_petal_size, petal$log_mas_size, method = "pearson")
summary(correlation)
print(paste("Correlation between log-transformed petal size and MAS size:", correlation))

#Create the plot
correlation_plot <- ggplot(petal, aes(x = log_petal_size, y = log_mas_size)) +
  geom_point(color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  labs(x = "Log Petal Size", y = "Log MAS Size",
       title = paste("Correlation between Log-Transformed Petal Size and MAS Size\nPearson Correlation:", round(correlation, 2))) +
  theme_minimal()

#Print the plot
print(correlation_plot)

#Save the plot as SVG
ggsave("correlation_plot.svg", plot = correlation_plot, device = "svg", bg = "white")



###plotting#####
####generate a Broken Stick Model plot######
#The Broken Stick model is a method traditionally used to help decide how many principal components to retain in PCA by
#comparing the eigenvalues of the components against a null model where variance is randomly split among components (like breaking a stick into parts).
eigenvalues <- pca_result$sdev^2
proportion_variance <- eigenvalues / sum(eigenvalues)

#Create a Broken Stick Model
broken_stick_model <- function(n) {
  bs <- numeric(n)
  for (i in 1:n) {
    bs[i] <- sum(1/(i:n))
  }
  return(bs / sum(bs))
}

#Calculate the Broken Stick values
broken_stick_values <- broken_stick_model(length(eigenvalues))

#Make a data frame for plotting
scree_data <- data.frame(
  PC = seq_along(eigenvalues),
  Eigenvalue = proportion_variance,
  Broken_Stick = broken_stick_values
)

#Create the scree plot with Broken Stick Model
scree_plot <- ggplot(scree_data, aes(x = PC)) +
  geom_bar(aes(y = Eigenvalue, fill = "Mean of igenvalues"), stat = "identity") +
  geom_line(aes(y = Broken_Stick, color = "Broken stick"), size = 1) +
  geom_point(aes(y = Broken_Stick, color = "Broken stick"), size = 2, shape = 1) +
  scale_fill_manual(values = "grey", labels = "Mean of eigenvalues") +
  scale_color_manual(values = "black", labels = "Broken stick") +
  theme_minimal() +
  theme(
    text = element_text(family = "serif", size = 15, color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5),
    legend.position = "right",
    axis.title = element_text(family = "serif", size = 13, color = "black"),  #Adjusting Axis titles
    axis.text = element_text(family = "serif", size = 13, color = "black"),  #Adjusting Axis text (ticks)
  )+
  labs(x = "Principal components",
       y = "Eigenvalue")
#Print the scree plot
print(scree_plot)

#Save the plot
ggsave("PCA_scree_plot_with_broken_stick.svg", scree_plot, width = 10, height = 6, dpi = 300)








################random code###############
#1. Check if the Data is Positive
#Check for negative values
any_negative_values <- any(scores_df$Showiness < 0)
print(any_negative_values)
#Check for zero values
any_zero_values <- any(scores_df$Showiness == 0)
print(any_zero_values)
#Summary statistics
summary(scores_df$Showiness)

#2.Check if the Data is Skewed
#Plot the histogram to visually inspect skewness
hist(scores_df$Showiness, breaks = 20, main = "Histogram of Showiness", xlab = "Showiness")
#Plot the Q-Q plot to inspect skewness
qqnorm(scores_df$Showiness, main = "Q-Q Plot of Showiness")
qqline(scores_df$Showiness, col = "red")
#Calculate skewness using the 'e1071' package
library(e1071)
showiness_skewness <- skewness(scores_df$Showiness)
print(showiness_skewness)

#3Check if the Data is Continuous
#Check for unique values to determine if the data is continuous
unique_values_count <- length(unique(scores_df$Showiness))
print(unique_values_count)

#If the number of unique values is large, the data is likely continuous
if (unique_values_count > 20) {
  print("The Showiness data is likely continuous.")
} else {
  print("The Showiness data may not be continuous.")
}
